app.controller("upgradeTaskC",["$scope","$http","$location","$rootScope",function(t,e,a,r){var o={},i=!1;t.initFormData=function(){t.dialog=!1,t.checkedAll=!1,t.showNext=!1,t.targetVersionList=[],t.taskDeviceList={},t.act="",t.deleteForm={},t.addForm={taskName:"",productKey:"",productModel:"",upgradableVersion:"",firmwareVersion:"",targetVersion:"",upgradeWay:"",upgradeAll:"",deviceList:[],typeName:"",type:""},t.readyVersionList=[],t.choseVersionList=[],t.forbiddenForm={},t.choseDialog=!1,t.searchVersion="",t.searchDevice="",t.readyDeviceList=[],t.choseDeviceList=[],t.dialogTitle="",t.deviceForm={list:[],data:""}};o={};t.filterForm={type:"",productKey:"",productModel:"",upgradeWay:"",upgradableVersion:"",targetVersion:""},t.productTypeList=JSON.parse(sessionStorage.getItem("productNameList")),t.filterProduct=function(a){t.productTypeList.forEach(function(e){a.productModel==e.productModel&&(a.productKey=e.productKey)})},t.getTableList=function(e,a,r,i){dataRequest("GET","manage/firmwareVersionTask/getFirmwareUpgradeTaskList",{pageNum:e,pageSize:a,productKey:r.productKey,productModel:r.productModel,upgradeWay:r.upgradeWay,upgradableVersion:r.upgradableVersion,targetVersion:r.targetVersion,type:r.type},function(e){t.tableList=e.data,i&&pageUtils(e.total,"UT_tableList",function(e){t.getTableList(e.curr,e.limit,o,!1)}),t.$apply()})},t.handleSearch=function(){o=t.filterForm,t.getTableList(1,10,o,!0)},t.handleEdit=function(e){i=!0;var a={id:e.id};$.ajax({type:"get",url:"/web/api/manage/firmwareVersionTask/getFirmwareUpgradeTaskInfo",data:a,dataType:"json",success:function(e){2==e.data.upgradeAll&&t.getTaskDeviceList(e.data),t.dialog=!0,t.act="edit",t.dialogTitle="编辑任务",t.addForm=e.data,t.addForm.typeName=1==e.data.type?"模组升级":2==e.data.type?"主板升级":"",t.getTargetVersionList(),t.addForm.upgradeWay=t.addForm.upgradeWay.toString(),t.addForm.firmwareVersion=t.addForm.targetVersion,t.$apply()},error:function(e){console.log(e)}})},t.handleAdd=function(){t.initFormData(),t.act="add",t.dialogTitle="添加任务",t.dialog=!0},t.handleShowVersion=function(e){t.act="showDeviceList",t.dialogTitle="起始版本",t.deviceForm.data="产品"+e.productModel+"  固件版本："+e.upgradableVersion,t.dialog=!0},t.handleShowDevice=function(e){if(t.act="showDeviceList",t.dialogTitle="设备列表",1==e.upgradeAll)t.deviceForm.data="产品:"+e.productModel+"  所有设备";else{var a={taskId:e.id};$.ajax({type:"get",url:"/web/api/manage/firmwareVersionTask/getFirmwareUpgradeDeviceNoPageList",data:a,dataType:"json",success:function(e){t.deviceForm.list=e.data,t.$apply()},error:function(e){console.log(e)}})}t.dialog=!0},t.getTargetVersionList=function(){t.addForm.productKey="";for(var e=0,a=t.productTypeList.length;e<a;e++)t.addForm.productModel==t.productTypeList[e].productModel&&(t.addForm.productKey=t.productTypeList[e].productKey);if(""==t.addForm.typeName||""==t.addForm.productModel)return!1;t.filterProduct(t.addForm);var r={pageNum:1,pageSize:1e3,type:"模组升级"==t.addForm.typeName?"1":"2",productKey:t.addForm.productKey,status:1};JSON.parse(sessionStorage.getItem("productNameList"));$.ajax({type:"get",url:"/web/api/manage/firmwareVersion/getFirmwareVersionNoPageList",data:r,dataType:"json",success:function(e){t.targetVersionList=e.data,t.$apply()},error:function(e){console.log(e)}}),0==i&&(t.addForm.firmwareVersion="",t.addForm.upgradableVersion=""),"add"==t.act&&(t.addForm.firmwareVersion="",t.addForm.upgradableVersion=""),i=!1},t.handleChoseVersion=function(){""==t.addForm.productKey?alert("请先选择产品型号"):""==t.addForm.typeName?alert("请先选择任务类型"):(t.dialogTitle="添加起始固件版本",t.choseDialog=!0,t.handleSearchVersion())},t.handleSearchVersion=function(){var e={type:"主板升级"==t.addForm.typeName?"2":"1",productKey:t.addForm.productKey,firmwareVersion:t.searchVersion};$.ajax({type:"get",url:"/web/api/manage/firmwareVersion/getFirmwareVersionDistribution",data:e,dataType:"json",success:function(e){var a=[];for(var r in t.readyVersionList)t.readyVersionList[r].check&&a.push(t.readyVersionList[r]);if(t.readyVersionList=[],e.data.length<1)alert("未搜索到相应固件版本");else{for(var r in e.data)t.readyVersionList.push({firmwareVersion:e.data[r],productKey:t.addForm.productKey,check:!1});for(var r in t.readyVersionList)for(var i in a)a[i].productKey==t.readyVersionList[r].productKey&&a[i].firmwareVersion==t.readyVersionList[r].firmwareVersion&&(t.readyVersionList[r].check=!0)}t.$apply()},error:function(e){console.log(e)}})},t.handleCheckVersion=function(e,a){t.readyVersionList[a].check=!t.readyVersionList[a].check},t.getFirmwareVersion=function(){""!=t.addForm.firmwareVersion&&(t.addForm.targetVersion=t.addForm.firmwareVersion)},t.handelSelectDevice=function(){return t.addForm.productKey?t.addForm.upgradableVersion?t.addForm.targetVersion?t.addForm.upgradeWay?t.handleDealAllReadyDevice():alert("请先选择升级方式"):alert("请先选择目标版本"):alert("请先选择起始版本"):alert("请先选择产品型号"),!1},t.handleSearchDevice=function(){if(""==t.searchDevice)return alert("请输入待选择SN码，以xxxxx,xxxxx的形式批量查询"),!1;var e={batchSnCode:t.searchDevice,productKey:t.addForm.productKey,pageNum:1,pageSize:1e5,filterSncode:!0};$.ajax({type:"get",url:"/web/api/manage/device/batchDeviceList",data:e,dataType:"json",success:function(e){for(var a in t.readyDeviceList=e.data,t.readyDeviceList)t.readyDeviceList[a].checked=!1;t.handleDealAllReadyDevice(),t.$apply()},error:function(e){console.log(e)}})},t.handleDealAllReadyDevice=function(){t.choseDeviceDialog=!0},t.handleCheckDevice=function(e,a){t.readyDeviceList[a].checked=!t.readyDeviceList[a].checked},t.getTaskDeviceList=function(e){var a={taskId:e.id};$.ajax({type:"get",url:"/web/api/manage/firmwareVersionTask/getFirmwareUpgradeDeviceNoPageList",data:a,dataType:"json",success:function(e){t.addForm.deviceList=[];for(var a=0,r=e.data.length;a<r;a++)t.addForm.deviceList.push({productKey:e.data[a].productKey,deviceName:e.data[a].deviceName,sncode:e.data[a].sncode,deviceId:e.data[a].deviceId});t.addForm.deviceList=JSON.stringify(t.addForm.deviceList)},error:function(e){console.log(e)}})},t.handleDelete=function(e){t.act="delete",t.dialogTitle="删除任务",t.deleteForm=e,t.dialog=!0},t.handleForbidden=function(e){t.act="forbidden",t.forbiddenForm=e,t.dialog=!0},t.handleNext=function(e){if(t.choseDialog){for(var a in t.readyVersionList)t.readyVersionList[a].check&&!0;for(var r=!(t.addForm.upgradableVersion=""),i=0;i<t.readyVersionList.length;i++)t.readyVersionList[i].check&&(r?(t.addForm.upgradableVersion=t.addForm.upgradableVersion+t.readyVersionList[i].firmwareVersion,r=!1):t.addForm.upgradableVersion=t.addForm.upgradableVersion+","+t.readyVersionList[i].firmwareVersion);t.searchVersion="",t.choseDialog=!1}else if(t.choseDeviceDialog){if(0==t.choseDeviceList.length)return alert("请至少选择一个设备"),!1;for(var a in t.addForm.deviceList=[],t.choseDeviceList)t.addForm.deviceList.push({productKey:t.choseDeviceList[a].productKey,deviceName:t.choseDeviceList[a].deviceName,sncode:t.choseDeviceList[a].sncode,deviceId:t.choseDeviceList[a].deviceId});t.addForm.deviceList=JSON.stringify(t.addForm.deviceList),t.dialog=!1,t.handleSubmit()}},t.handleSubmit=function(e){if("forbidden"==t.act)var a="web/api/manage/firmwareVersionTask/forbidden",r={id:t.forbiddenForm.id,status:1==t.forbiddenForm.status?0:1},i=1==t.forbiddenForm.status?"停用成功！":"启用成功！";else if("delete"==t.act)a="/web/api/manage/firmwareVersionTask/delete",r={id:t.deleteForm.id},i="删除成功！";else{if("showDeviceList"==t.act)return t.handleCancel(),!0;if("add"==t.act){if(!t.addForm.productModel)return alert("请先选择产品型号"),!1;if(!t.addForm.typeName)return alert("请先选择任务类型"),!1;if(!t.addForm.upgradableVersion)return alert("请先选择起始版本"),!1;if(!t.addForm.targetVersion)return alert("请先选择目标版本"),!1;if(!t.addForm.upgradeWay)return alert("请先选择升级方式"),!1;if("2"==t.addForm.upgradeAll&&t.addForm.deviceList.length<1)return alert("请先选择目标设备"),!1;t.addForm.type="模组升级"==t.addForm.typeName?"1":"2";a="/web/api/manage/firmwareVersionTask/saveFirmwareUpgradeTask",r=t.addForm,i="创建成功！"}else if("edit"==t.act)a="/web/api/manage/firmwareVersionTask/saveFirmwareUpgradeTask",r=t.addForm,i="编辑成功！"}$.ajax({type:"post",url:a,data:r,dataType:"json",success:function(e){e.success?(alert(i),t.getTableList(1,10,o,!0)):alert(e.message),t.handleCancel()},error:function(e){console.log(e)}})},t.handleCancel=function(){t.choseDialog||t.choseDeviceDialog?(t.choseDialog=!1,t.choseDeviceDialog=!1):t.initFormData()},t.handleChoseDeviceAll=function(){for(var e in t.readyDeviceList)t.readyDeviceList[e].checked=!t.checkedAll;t.checkedAll=!t.checkedAll},t.handleInputChoseDevice=function(){var e=!1;for(var a in t.readyDeviceList)if(e=!1,t.readyDeviceList[a].checked){if(0!=t.choseDeviceList.length)for(var r in t.choseDeviceList)t.choseDeviceList[r].sncode==t.readyDeviceList[a].sncode&&(e=!0);e||t.choseDeviceList.push(t.readyDeviceList[a])}},t.handleDelDeviceInReady=function(e,a){t.choseDeviceList.splice(a,1)},t.getTableList(1,10,t.filterForm,!0),t.initFormData()}]),app.controller("firmwareVersionC",["$scope","$http","$location","$rootScope",function(o,e,a,r){o.uploadInst=null,o.productNameList=JSON.parse(sessionStorage.getItem("productNameList")),o.productTypeList=JSON.parse(sessionStorage.getItem("productType")),o.dialog=function(e,a){o.fun=e,o.id=a,o.dialogStyle="delete"==e||"on"==e||"off"==e?{zIndex:19891015,width:"400px",height:"170px",top:"30%",left:"50%",marginLeft:"-200px"}:{zIndex:19891015,width:"500px",height:"450px",top:"20%",left:"50%",marginLeft:"-200px"},"edit"==e&&dataRequest("get","manage/firmwareVersion/getFirmwareVersionInfo",{id:o.id},function(a){o.newForm=a.data,o.newForm.typeName=1==o.newForm.type?"模组":"主板",o.productNameList.forEach(function(e){e.productKey==a.data.productKey&&(o.newForm.productModel=e.productModel)}),o.$apply()}),"add"==e&&(o.newForm={fileSize:"",crcSign:"",productKey:"",productModel:"",firmwareModel:2,firmwareVersion:"",downLoadUrl:"",description:"",type:"",typeName:""}),$(".layui-layer-shade").show(),$(".layui-layer").show()},o.close=function(){$(".layui-layer-shade").hide(),$(".layui-layer").hide()},o.form={productType:"",moduleModel:"",productModel:"",firmwareVersion:""},o.init=function(e,a,r,i){dataRequest("get","manage/firmwareVersion/getFirmwareVersionList",_extends({pageNum:e,pageSize:a},r),function(e){o.firmwareList=e.data,i&&pageUtils(e.total,"firmwareList",function(e){o.init(e.curr,e.limit,o.form,!1)}),o.$apply()})},o.init(1,10,o.form,!0),o.updataFile=function(e){$.ajax({type:"POST",url:config.webAPI.address+"common/uploadFile",data:e,contentType:!1,cache:!1,processData:!1,xhr:function(){var e=$.ajaxSettings.xhr();return e.upload&&e.upload.addEventListener("progress",function(e){var a=e.loaded,r=e.total,i=Math.floor(100*a/r);$(".progress").css("width",i+"%")},!1),e},success:function(e){e.success?(alert("上传成功！"),o.newForm.downLoadUrl="http://"+window.location.host+"/web/api/common/getFiles/"+e.data.fileId):alert(e.message),$(".layui-progress").hide()},error:function(e){$(".layui-progress").hide()}})},layui.use("upload",function(){var t=layui.jquery,e=layui.upload;o.uploadInst=e.render({elem:"#testList",accept:"file",multiple:!0,auto:!1,choose:function(e){e.preview(function(e,a,r){if(""==o.newForm.typeName)return alert("请先选择固件类型"),!1;if(10<a.name.length&&"主板"==o.newForm.typeName)return alert("主板升级文件名长度请控制在10个以内（文件名包括文件类型以及 . ）!"),!1;if(83886080<a.size)return alert("上传文件超出80M大小!"),!1;t(".layui-progress").show(),t(".loading").hide();var i=new FormData;i.append("file",a),o.updataFile(i),o.newForm.downLoadUrl=a.name,o.$apply()})}})}),o.save=function(){if("add"==o.fun||"edit"==o.fun){if(""==o.newForm.productName)return alert("请选择产品类型！"),!1;if(""==o.newForm.typeName)return alert("请选择固件类型！"),!1;if(""==o.newForm.firmwareModel)return alert("请选择模块型号！"),!1;if(""==o.newForm.firmwareVersion)return alert("请填写固件版本！"),!1;if(""==o.newForm.crcSign&&"模组"!=o.newForm.typeName)return alert("请填写CRC！"),!1;if(""==o.newForm.fileSize&&"模组"!=o.newForm.typeName)return alert("请填写文件长度！"),!1;if(""==o.newForm.downLoadUrl)return alert("请上传新固件！"),!1;o.productNameList.forEach(function(e){e.productModel==o.newForm.productModel&&(o.newForm.productKey=e.productKey)}),o.newForm.type="模组"==o.newForm.typeName?"1":"2",dataRequest("post","manage/firmwareVersion/saveFirmwareVersion",o.newForm,function(e){e.success?("add"==o.fun?alert("新增成功！"):alert("编辑成功！"),o.uploadInst.config.elem.next()[0].value="",o.init(1,10,o.form,!0),o.$apply()):alert(e.message)}),o.close()}else"delete"==o.fun?dataRequest("post","manage/firmwareVersion/deleteFirmwareVersion",{id:o.id},function(e){e.success?(alert("删除成功！"),o.init(1,10,o.form,!0)):alert(e.message)}):dataRequest("post","manage/firmwareVersion/forbidden",{id:o.id,status:"on"==o.fun?1:0},function(e){e.success?(alert("on"==o.fun?"启用":"禁用成功！"),o.init(1,10,o.form,!0)):alert(e.message)}),o.close()}}]);