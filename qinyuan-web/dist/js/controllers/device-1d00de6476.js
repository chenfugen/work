"use strict";app.controller("deviceListC",["$scope","$timeout","$http","$location","$rootScope",function(m,e,t,i,a){JSON.parse(sessionStorage.getItem("permission")).forEach(function(e){"/web/api/manage/device/detail"==e.url&&(m.isDetail=e.checked)});var d,n,r,o="",c="";m.initDateComponent=function(){document.getElementById("datessss").value="",layui.use(["form","layedit","laydate"],function(){layui.form,layui.layer,layui.layedit;layui.laydate.render({elem:"#datessss",type:"datetime",format:"yyyy-MM-dd HH:mm:ss",trigger:"click",range:!0,isInitValue:!1,done:function(e,t,i){e.length<1?(m.leaseTime.startTime="",m.leaseTime.endTime=""):(m.leaseTime.startTime=t.year+"-"+t.month+"-"+t.date+" "+t.hours+":"+t.minutes+":"+t.seconds,m.leaseTime.endTime=i.year+"-"+i.month+"-"+i.date+" "+i.hours+":"+i.minutes+":"+i.seconds)}})})},m.initDateComponent(),m.productNameList=JSON.parse(sessionStorage.getItem("productNameList")),m.init=function(e,t,i,a,n,r,d,o,c,s,l,u,p){dataRequest("GET",apiConfig.manage_device_list,{pageNum:e,pageSize:t,deviceName:i,status:a,provinceId:n,cityId:r,filterStatus:d,errorStatus:o,productModel:c,mac:l,sncode:u,leaseType:p},function(e){m.devices=e.data,m.$apply(),s&&pageUtils(e.total,"productAll",function(e){m.unfold=-1,m.init(e.curr,e.limit,m.name,m.status,m.provinceId,m.cityId,m.filterStatus,m.errorStatus,m.productModel,!1,m.mac,m.sncode,m.leaseType)})})},m.init(1,10,"","","","","","","",!0,m.mac,m.sncode,m.leaseType,m.deviceName),dataRequest("GET",apiConfig.manage_device_deviceCount,{pageNum:1,pageSize:10},function(e){m.deviceNum=e.data,m.$apply()}),m.goDetail=function(e){clearInterval(l),i.path("/deviceDetail/"+e)},m.searchDevice=function(){""!=m.region&&null!=m.region||(m.provinceId=void 0,m.cityId=void 0),m.init(1,10,m.deviceName,m.status,m.provinceId,m.cityId,m.filterStatus,m.errorStatus,m.productModel,!0,m.mac,m.sncode,m.leaseType)};var s=document.location.origin.split("//")[1];switch(-1!=s.indexOf(":")&&(s=s.split(":")[0]),s){case"iot2.qinyuan.cn":s="iot2-webview.qinyuan.cn",r="18907";break;case"qinyuan-slb.yunext.com":r="18094";break;default:s="qinyuan-test.yunext.com",r="18094"}var l=null;m.$on("$destroy",function(){m.handleDealHb(0)}),m.handleDealHb=function(e){1==e?l=setInterval(function(){d.send(JSON.stringify({v:1,cmd:"hb"}))},4e4):clearInterval(l)},m.websorket=function(){(d=new WebSocket("wss://"+s+":"+r+"/ws")).onopen=function(e){var t={version:1,cmd:"connect",token:getCookie("token")};d.send(JSON.stringify(t))},d.onmessage=function(e){var t=JSON.parse(e.data);if("connect"==t.cmd&&m.handleDealHb(1),"subscribe"==t.cmd&&1==o){var i={version:1,cmd:"service",productId:m.productKey,moduleId:m.deviceName,method:"query"};d.send(JSON.stringify(i)),alert("正在尝试与该设备"+m.deviceName+"连接，请等待。"),c=1}if("deviceInfo"==t.cmd){var a=0;for(var n in t.data)a++;2<a&&1==c&&(m.deviceInfo=t.data,c=0,alert("已经与该设备"+m.deviceName+"建立连接，可开始控制。"));var r=Object.getOwnPropertyNames(t.data).length;for(var n in t.data)m.deviceInfo[n].value=t.data[n].value;r<3&&(t.data.PowerSwitch&&1==t.data.PowerSwitch.value&&alert("设备"+t.moduleId+"已开机"),t.data.PowerSwitch&&0==t.data.PowerSwitch.value&&alert("设备"+t.moduleId+"已关机"),t.data.LockSwitch&&alert("设备"+t.moduleId+"已解锁"),t.data.GetWaterType&&alert("设备"+t.moduleId+"出水方式已修改"),t.data.HeatWaterTempSwitch&&alert("设备"+t.moduleId+"制热温度已经修改"),t.data.HeatingSwitch&&alert("设备"+t.moduleId+"开始加热"),t.data.HeatingSwitch&&alert("设备"+t.moduleId+"已停止加热"),t.data.RefrigerationSwitch&&alert("设备"+t.moduleId+"操作成功"),t.data.RefrigerationSwitch&&alert("设备"+t.moduleId+"已关闭制冷"),t.data.ChildLockSwitch&&1==t.data.ChildLockSwitch.value&&alert("设备"+t.moduleId+"已开启童锁"),t.data.ChildLockSwitch&&0==t.data.ChildLockSwitch.value&&alert("设备"+t.moduleId+"已关闭童锁")),t.data.online&&($(".layui-layer-shade").hide(),$(".heating").hide(),t.data.online.value?alert("设备"+t.moduleId+"上线"):alert("设备"+t.moduleId+"下线")),m.$apply()}},d.onerror=function(e){console.log(e)},d.onclose=function(e){console.log("Connection closed.")},d.addEventListener("close",function(e){e.code,e.reason,e.wasClean})},m.unfold=-1,m.onOff=function(e,t,i,a){var n={version:1,cmd:"subscribe",flag:"on",productId:m.productKey=i,moduleId:m.deviceName=t};if(-1==m.unfold)m.unfold=e,"NET_GPRS"==a&&(1==d.readyState?(d.send(JSON.stringify(n)),o=1):alert("WS未连接成功，请刷新页面重试。"));else{if(m.unfold=-1,"NET_GPRS"==a){n={version:1,cmd:"subscribe",flag:"off",productId:m.productKey,moduleId:m.deviceName};d.send(JSON.stringify(n))}o=0}},m.websorket(),m.selectSwitch=function(){1==m.oprateWay?m.numList=[0]:m.numList=[40,50,60,70,80,90,100]},m.getLeaseInfo=function(e){dataRequest("GET",apiConfig.manage_deviceLease_getDeviceLeaseInfo,{deviceId:e},function(e){e.data?(m.leaseHisTime.startTime=e.data.leaseStartTime,m.leaseHisTime.endTime=e.data.leaseEndTime):(m.leaseHisTime.startTime="--",m.leaseHisTime.endTime="--"),m.$apply()})},m.leaseTime={startTime:"",endTime:""},m.leaseHisTime={startTime:"",endTime:""},m.handleClearError=function(e){m.dialogStyle={zIndex:19891015,width:"400px",height:"150px",top:"20%",left:"50%",marginLeft:"-250px"},m.fun="clear",$(".layui-layer-shade").show(),$(".func").show();var t="NET_GPRS"==e.netType?apiConfig.manage_device_cleanIOTDeviceError:apiConfig.manage_device_cleanIlopDeviceError,i={deviceId:e.deviceId};m.close=function(){$(".layui-layer-shade").hide(),$(".layui-layer").hide()},m.save=function(){dataRequest("post",t,i,function(e){e.success?alert("清除指令已下发，请稍后刷新数据。"):alert(e.message),m.init(1,10,"","","","","","","",!0,m.mac,m.sncode,m.leaseType,m.deviceName),m.$apply()}),m.close()}},m.dialog=function(i,a){return 2!=a.resource&&"NET_GPRS"!=a.netType?(alert("该操作只针对2G设备"),!1):"on"!=i&&"WaterType"!=i&&"heat"!=i||"离线"!=a.status?(m.fun=i,m.deviceName=a.deviceName,m.productKey=a.productKey,n=-1,"on"==i||"unlink"==i||"lift"==i||"lift"==i?m.dialogStyle={zIndex:19891015,width:"400px",height:"180px",top:"30%",left:"50%",marginLeft:"-200px"}:"WaterType"==i||"heat"==i?m.dialogStyle={zIndex:19891015,width:"400px",height:"300px",top:"20%",left:"50%",marginLeft:"-250px"}:"unlock"==i?(m.initDateComponent(),m.getLeaseInfo(a.deviceId),m.dialogStyle={zIndex:19891015,width:"550px",height:"280px",top:"20%",left:"50%",marginLeft:"-270px"}):m.dialogStyle="updateLease"==i?{zIndex:19891015,width:"400px",height:"240px",top:"30%",left:"50%",marginLeft:"-200px"}:{zIndex:19891015,width:"400px",height:"320px",top:"20%",left:"50%",marginLeft:"-250px"},$(".layui-layer-shade").show(),$(".func").show(),m.close=function(){$(".layui-layer-shade").hide(),$(".layui-layer").hide()},void(m.save=function(){var e={version:1,cmd:"control",productId:m.productKey,moduleId:m.deviceName,data:{}};if("on"==i&&(0==c?(e.data.PowerSwitch=1==m.deviceInfo.PowerSwitch.value?0:1,e.data.PowerSwitch,d.send(JSON.stringify(e)),alert("控制消息已发送，请稍后")):alert("设备连接延迟或设备异常，请稍后再试")),"unlock"==i||"updateLease"==i){if("unlock"==i){if(m.leaseStatus="1",""==m.leaseTime.startTime||null==m.leaseTime.startTime)return alert("请选择租赁时间!"),!1}else if(""==m.leaseStatus||null==m.leaseStatus)return alert("请选择租赁状态!"),!1;dataRequest("post",apiConfig.manage_deviceLease_saveDeviceLease,{deviceId:a.deviceId,leaseStartTime:m.leaseTime.startTime,leaseEndTime:m.leaseTime.endTime,leaseStatus:m.leaseStatus},function(e){e.success?alert("操作成功!"):alert(e.message)})}if("WaterType"==i){if(""==m.method||null==m.method)return alert("请选择出水方式!"),!1;0==c?(1,e.data.GetWaterType=m.method-1,d.send(JSON.stringify(e)),alert("控制消息已发送，请稍后")):alert("设备连接延迟或设备异常，请稍后再试")}if("heat"==i){if(null==m.oprateWay)return alert("请选择温度操作方式!"),!1;if(0==m.oprateWay&&null==m.temp&&"关"==$("#HeatingSwitch em").text())return alert("请选择加热温度和加热状态!"),!1;if(0==m.oprateWay&&-1==n&&"关"==$("#HeatingSwitch em").text())return alert("请选择开启加热状态!"),!1;if(1==m.oprateWay&&-1==n&&"关"==$("#HeatingSwitch em").text())return alert("请选择开启制冷状态!"),!1;n="开"==$("#HeatingSwitch em").text()?1:0,0==m.oprateWay?(e.data.HeatingSwitch=n,e.data.HeatWaterTempSwitch=parseInt(m.temp)):e.data.RefrigerationSwitch=n,0==c?(d.send(JSON.stringify(e)),alert("加热命令已发送")):alert("设备连接延迟或设备异常，请稍后再试")}if("lift"==i&&(0==c?(e.data.ChildLockSwitch=1==m.deviceInfo.ChildLockSwitch.value?0:1,e.data.ChildLockSwitch,d.send(JSON.stringify(e)),alert("控制消息已发送，请稍后")):alert("设备连接延迟，请稍后再试")),"time"==i){var t;if("开"==$("#timeSwitch em").text()){if(t=1,null==m.energyTime||""==m.energyTime)return alert("请选择节能时间！"),!1}else t=0,m.energyTime=0;dataRequest("post",apiConfig.manage_deviceSaveEnergy_saveDeviceSaveEnergy,{deviceId:a.deviceId,minutes:60*parseInt(m.energyTime),energySwitch:t},function(e){e.success?alert("操作成功!"):alert(e.message)})}m.close()})):(alert("该设备离线中，无法进行操作!"),!1)}}]),app.controller("deviceTrendC",["$scope","$http","$location","$rootScope",function(u,e,i,t){JSON.parse(sessionStorage.getItem("permission")).forEach(function(e){"/web/api/manage/device/trend/deviceError/list"==e.url&&(u.isDeviceError=e.checked),"/web/api/manage/device/trend/deviceCount"==e.url&&(u.isCount=e.checked)}),u.productTypeList=JSON.parse(sessionStorage.getItem("productType")),u.rankList=[9,8,7,6,5,4,3,2,1],dataRequest("get",apiConfig.common_getErrorName_list,{},function(e){u.errorList=e.data,u.$apply(u.errorList)}),u.init=function(e,t,i,a,n,r,d,o,c,s,l){dataRequest("GET",apiConfig.manage_device_trend_list,{timeType:e,productType:t,deviceName:i,time:a,provinceId:n,cityId:r,pageSize:d,pageNum:o,mac:s,sncode:l},function(e){isRoot(u.isDevice,"设备新增列表",function(){u.devices=e.data,c&&pageUtils(e.total,"productAll",function(e){u.time=$("#test1").val(),u.init(p,u.productName,u.deviceName,u.time,u.provinceId,u.cityId,e.limit,e.curr,!1,u.mac,u.sncode)}),u.$apply()})}),dataRequest("GET",apiConfig.manage_device_trend_deviceCount,{timeType:e},function(e){isRoot(u.isCount,"设备新增、报修新增、故障新增数据统计",function(){u.deviceCount=e.data}),u.$apply()})},u.deviceError=function(e,t,i,a,n,r,d,o,c){dataRequest("GET",apiConfig.manage_breakdowns_getDeviceCurrentErrorTrent,{timeType:e,rank:t,errorName:i,time:a,province:n,city:r,pageNum:d,pageSize:o},function(e){isRoot(u.isDeviceError,"故障新增列表",function(){u.deviceerror=e.data,u.$apply(),c&&pageUtils(e.total,"deviceAll",function(e){u.time=$("#date2").val(),u.deviceError(p,u.level,u.errorName,u.time,u.provinceId,u.cityId,e.curr,e.limit,!1)})})})},u.breakdownList=function(e,t,i,a,n,r,d,o){dataRequest("GET",apiConfig.manage_breakdowns_getBreakdownDealList,{timeType:e,deviceName:t,userPhone:i,status:a,time:n,pageNum:r,pageSize:d},function(e){u.breakList=e.data,u.$apply(),o&&pageUtils(e.total,"repairAll",function(e){u.time=$("#date1").val(),u.breakdownList(p,u.deviceName,u.userPhone,u.status,u.time,e.curr,e.limit,!1)})})};var p=1;u.times=p,u.selectTime=function(e){p=e,u.init(p,u.productName,u.deviceName,u.time,u.provinceId,u.cityId,10,1,!0,u.mac,u.sncode),u.deviceError(p,u.level,u.errorName,u.time,u.provinceId,u.cityId,1,10,!0),u.breakdownList(p,u.deviceName,u.userPhone,u.status,u.time,1,10,!0)},u.selectNav=function(e){u.times=e},u.init(p,u.productName,u.deviceName,u.time,u.provinceId,u.cityId,10,1,!0,u.mac,u.sncode),u.deviceError(p,u.level,u.errorName,u.time,u.provinceId,u.cityId,1,10,!0),u.breakdownList(p,u.deviceName,u.userPhone,u.status,u.time,1,10,!0),u.goDetail=function(e){i.path("/deviceDetail/"+e)},u.goFault=function(e,t){i.path("/faultDetails/"+e+"/"+t)},u.isRegion=!1,u.search=function(e){""==$(".cityselect").val()||null==$(".cityselect").val()?(u.provinceId=void 0,u.cityId=void 0):(u.provinceId=$(".province").html(),u.cityId=$(".city").html()),1==e?(u.time=$("#test1").val(),u.init(p,u.productName,u.deviceName,u.time,u.provinceId,u.cityId,10,1,!0,u.mac,u.sncode)):2==e?(u.time=$("#date1").val(),u.breakdownList(p,u.deviceName,u.userPhone,u.status,u.time,1,10,!0)):(u.time=$("#date2").val(),u.deviceError(p,u.level,u.errorName,u.time,u.provinceId,u.cityId,1,10,!0))}}]),app.controller("deviceMapC",["$scope","$http","$location","$rootScope",function(u,e,t,i){u.productNameList=JSON.parse(sessionStorage.getItem("productNameList")),u.init=function(e,t,i,a,n,r,d,o,c,s,l){dataRequest("GET",apiConfig.manage_device_list,{pageNum:e,pageSize:t,name:i,activeStatus:1,status:a,provinceId:n,cityId:r,filterStatus:d,errorStatus:o,mac:s,sncode:l},function(e){u.devices=e.data,c&&pageUtils(e.total,"productAll",function(e){u.init(e.curr,e.limit,u.name,u.status,u.provinceId,u.cityId,u.filterStatus,u.errorStatus,!1,u.mac,u.sncode)}),u.$apply()})},u.init(1,10,"","","","","","",!0,u.mac),u.searchs=function(){""!=u.region&&null!=u.region||(u.provinceId=void 0,u.cityId=void 0),u.init(1,10,u.name,u.status,u.provinceId,u.cityId,u.filterStatus,u.errorStatus,!0,u.mac,u.sncode)},u.goDetail=function(e){t.path("/deviceDetail/"+e)}}]),app.controller("deviceDetailC",["$scope","$http","$location","$routeParams",function(n,e,i,r){var d=null,t=null;n.mapCenter={center:null,province:null,city:null},n.deviceMap=!0,n.searchKey="",n.showSetBtn=!1,n.showMapSearchResult=!1,n.poiData={},n.init=function(){dataRequest("GET",apiConfig.manage_device_detail,{id:r.id},function(e){n.device=e.data.deviceDetail,n.filterDetail=e.data.filterDetail,n.filter=e.data.filter,n.deviceSnapInfo=e.data.deviceSnapInfo,n.deviceLeaseConfig=e.data.deviceLeaseConfig,null!=n.filter&&("需要更换"==n.filter.filterStatus?$(".filterStaus").css({color:"#FFB800"}):"即将到期"==n.filter.filterStatus&&$(".filterStaus").css({color:"#FF5722"})),0!=Number(n.device.province)&&NaN!=Number(n.device.province)&&(n.mapCenter.province=n.device.province),0!=Number(n.device.city)&&NaN!=Number(n.device.city)&&(n.mapCenter.city=n.device.city),0!=Number(n.device.latitude)&&NaN!=Number(n.device.latitude)&&(n.mapCenter.center=[n.device.longitude,n.device.latitude]),n.$apply(),n.initMap()}),dataRequest("GET",apiConfig.manage_deviceProperties_getDevicePropertiesInfo,{deviceId:r.id},function(e){n.filterWater=e.data,n.$apply()})},n.init(),n.getDeviceMsg=function(){dataRequest("POST",apiConfig.manage_device_getIoTDeviceLeaseAndTraffic,{deviceId:r.id},function(e){n.deviceMsg=e.data,n.$apply()})},n.getDeviceMsg(),n.unbindUser=function(){dataRequest("GET",apiConfig.manage_device_detail_bindDeviceList,{deviceId:r.id,bindType:"1"},function(e){n.bindUsers=e.data,n.$apply()})},n.unbindUser(),n.shareUser=function(){dataRequest("GET",apiConfig.manage_device_detail_shareUser_list,{deviceId:r.id},function(e){n.shareUsers=e.data,n.$apply()})},n.shareUser(),n.deviceErrorList=function(){dataRequest("GET",apiConfig.manage_device_detail_deviceError_trend_list,{deviceId:r.id},function(e){n.ErrorList=e.data,n.$apply()})},n.deviceErrorList(),n.debugInt=function(e,t,i){dataRequest("GET",apiConfig.manage_deviceAuth_getDeviceLeaseAuthList,{deviceId:r.id,pageNum:e,pageSize:t},function(e){n.debugList=e.data,n.$apply(),i&&pageUtils(e.total,"debugList",function(e){n.debugInt(e.curr,e.limit,!1)})})},n.goDetail=function(e){i.path("/userDetails/"+e)},n.dialog=function(e,t){if(n.fun=e,n.id=t,"user"==n.fun||"sharaUser"==n.fun||"refuseCheck"==e||"passCheck"==e?(console.log(t),n.dialogStyle={zIndex:19891015,width:"400px",height:"180px",top:"30%",left:"50%",marginLeft:"-200px"}):"deBugEdit"==n.fun?(n.dialogStyle={zIndex:19891015,minWidth:"400px",width:"auto",height:"300px",top:"30%",left:"50%",marginLeft:"-200px"},n.deviceLeaseMinutes=n.deviceLeaseConfig.deviceLeaseMinutes.toString(),n.deviceLeaseNum=n.deviceLeaseConfig.deviceLeaseNum):(n.dialogStyle={zIndex:19891015,minWidth:"400px",width:"auto",height:"300px",top:"30%",left:"50%",marginLeft:"-200px"},n.tds=n.filterWater.tds,n.ntu=n.filterWater.ntu,n.residualChlorine=n.filterWater.residualChlorine),"filterEdit"==n.fun){n.filters=[];for(var i=0;i<n.filterDetail.length;i++)n.filters[i]={},n.filters[i].filterName=n.filterDetail[i].name,n.filters[i].filterPercent=n.filterDetail[i].percent}$(".layui-layer-shade").show(),$(".layui-layer").show()},n.resetDebug=function(e){n.dialogStyle={zIndex:19891015,minWidth:"400px",width:"auto",height:"150px",top:"30%",left:"50%",marginLeft:"-200px"},$(".layui-layer-shade").show(),n.dialogReset=!0},n.submitRestDebug=function(){var e=i.$$url.split("/deviceDetail/")[1],t=apiConfig.manage_deviceDebug_resetDeviceLeaseDebug;dataRequest("POST",t,{deviceId:e,productKey:n.device.productKey},function(e){alert(e.message),n.cancelResetDebug(),n.init()})},n.handleCheckFilterInput=function(e){var t=!0,i=n.filters[e].filterPercent;if(100<n.filters[e].filterPercent){for(;t;)(i=(i/10).toFixed(0))<=100&&(t=!1);n.filters[e].filterPercent=Number(i)}},n.cancelResetDebug=function(){n.dialogReset=!1,$(".layui-layer-shade").hide()},n.close=function(){$(".layui-layer-shade").hide(),$(".layui-layer").hide()},n.save=function(){var e;if("user"==n.fun||"sharaUser"==n.fun)e="user"==n.fun?apiConfig.manage_device_iotRemoveBindUser:apiConfig.manage_device_unbind_shareUser,dataRequest("POST",e,{deviceId:r.id,userId:n.id,type:2},function(e){e.success?(alert("解绑成功！"),n.shareUser(),n.unbindUser()):alert(e.message)});else if("bindUser"==n.fun){if(""==n.userPhone&&11==n.userPhone.length)return alert("请填写正确的用户手机号码！"),!1;dataRequest("POST",apiConfig.manage_device_iotBind,{identityId:n.device.mac,snCode:n.device.sncode,type:1,userPhone:n.userPhone,productKey:n.device.productKey},function(e){e.success?(alert("绑定成功！"),n.unbindUser(),n.init()):alert(e.message)})}else if("waterEdit"==n.fun){if(null!=n.tds){var t=n.tds.toString();n.tds=Number(t.split(".")[0])}if(300<n.tds||null==n.tds||null==n.ntu||2.55<n.ntu||null==n.residualChlorine||2.55<n.residualChlorine)return(300<n.tds||null==n.tds)&&(n.tds=300),(null==n.ntu||2.55<n.ntu)&&(n.ntu=2.55),(null==n.residualChlorine||2.55<n.residualChlorine)&&(n.residualChlorine=2.55),alert("数据设置异常，已修正，请再次提交");dataRequest("POST",apiConfig.manage_deviceProperties_saveDeviceProperties,{deviceId:r.id,TDS:n.tds,NTU:n.ntu,residualChlorine:n.residualChlorine},function(e){e.success?(alert("编辑成功!"),n.init()):alert(e.message)})}else if("deBugEdit"==n.fun){if(""==n.deviceLeaseMinutes||null==n.deviceLeaseMinutes)return alert("请选择调试时间！"),!1;if(""==n.deviceLeaseNum||null==n.deviceLeaseNum)return alert("请选择调试次数！"),!1;if(!(i=/^[1-9]+\d*$/).test(n.deviceLeaseNum))return alert("调试次数请填写大于零的正整数!"),!1;dataRequest("POST",apiConfig.manage_deviceDebug_saveDeviceLeaseDebug,{deviceId:r.id,leaseMinutes:n.deviceLeaseMinutes,leaseNum:n.deviceLeaseNum},function(e){e.success?(alert("编辑成功!"),n.init()):alert(e.message)})}else if("passCheck"==n.fun||"refuseCheck"==n.fun)dataRequest("POST",apiConfig.manage_deviceAuth_authDeviceLeaseDebug,{deviceId:r.id,id:n.id.id,status:"passCheck"==n.fun?"2":"3",productKey:n.device.productKey},function(e){e.success?(alert("操作成功!"),n.debugInt(1,10,!0)):alert(e.message)});else{for(var i=new RegExp("^(\\d|[1-9]\\d|100)$"),a=0;a<n.filters.length;a++){if(""!==n.filters[a].filterPercent&&void 0!==n.filters[a].filterPercent&&null!==n.filters[a].filterPercent||(n.filters[a].filterPercent=0),!i.test(n.filters[a].filterPercent))return alert("请正确填写"+n.filters[a].filterName+"寿命百分比_"+(a+1)+"！"),!1;n.filterDetail[a].name=n.filters[a].filterName,n.filterDetail[a].percent=n.filters[a].filterPercent}dataRequest("POST","manage/device/update/filterLife",{deviceId:r.id,filterData:JSON.stringify(n.filterDetail)},function(e){e.success?(alert("滤芯寿命修改指令已下发，请稍后刷新数据。"),n.init()):alert(e.message)})}n.close()},n.locationNow=function(){d=new AMap.Map("deviceAddress",{resizeEnable:!0,zoom:10,expandZoomRange:!0,zooms:[9,20]}),AMap.plugin("AMap.Geolocation",function(){var e=new AMap.Geolocation({enableHighAccuracy:!0,timeout:1e4,buttonPosition:"RB",buttonOffset:new AMap.Pixel(10,20),zoomToAccuracy:!0});d.addControl(e),e.getCurrentPosition(function(e,t){"complete"==e?function(e){n.mapCenter.city=e.addressComponent.city,n.mapCenter.province=e.addressComponent.province,n.mapCenter.center=[e.position.lng,e.position.lat]}(t):function(e){console.log("失败原因排查信息:"+e.message)}(t)})})},n.initMap=function(){if(null!=n.mapCenter.center){if(d=new AMap.Map("deviceAddress",{resizeEnable:!0,center:n.mapCenter.center,zoom:10,expandZoomRange:!0,zooms:[9,20]}),""!=n.device.longitude&&null!=n.device.longitude){var e=new AMap.Marker({position:n.mapCenter.center,map:d,icon:new AMap.Icon({image:"https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png"}),offset:new AMap.Pixel(-15,-15)}),t=document.createElement("div"),i=document.createElement("img");i.src="//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-red.png",t.appendChild(i);var a=document.createElement("span");a.className="CenterMarker",a.innerHTML="设备",t.appendChild(a),e.setContent(t)}}else n.locationNow()},n.handleGetlnglat=function(){n.showSetBtn=!1;var e="",i="",a="";n.region?(e=n.cityId?n.cityId:n.provinceId,new AMap.Geocoder({city:e}).getLocation(n.region,function(e,t){i=t.geocodes[0].location.lng,a=t.geocodes[0].location.lat,d.setCenter([i,a]),n.handleSearchLocation()})):(d.setCenter(n.mapCenter.center),n.handleSearchLocation())},n.handleSearchLocation=function(){var e="";e=n.region?n.cityId?n.cityId:n.provinceId:n.mapCenter.city,AMap.service(["AMap.PlaceSearch"],function(){(t=new AMap.PlaceSearch({pageSize:5,pageIndex:1,city:e,citylimit:!0,map:d,panel:"searchResult",autoFitView:!0})).search(n.searchKey,function(e,t){}),t.on("listElementClick",function(e){n.poiData=e,n.showSetBtn=!0,n.$apply()})})},n.handleSetLocation=function(){var e={deviceId:n.device.deviceId,latitude:n.poiData.data.location.lat,longitude:n.poiData.data.location.lng,province:n.poiData.data.pname,city:n.poiData.data.cityname,region:n.poiData.data.adname,address:n.poiData.data.address};dataRequest("POST",apiConfig.manage_device_reviseDeviceLocation,e,function(e){e.success?(alert("设置成功！"),d&&d.destroy(),t.clear(),n.showSetBtn=!1,n.searchKey="",n.$apply(),n.init()):alert(e.message)})},n.unbind=function(e,t){dataRequest("POST",apiConfig.manage_device_unbind_shareUser,{deviceId:e,userId:t},function(e){e.success?(alert("解绑成功！"),n.shareUser()):alert(e.message)})},n.deviceMsgPart=!0,n.userMsg=!0,n.filterTab=!0,n.waterTab=!0,n.debugTab=!0,n.debugHistroy=!0,n.packUp=function(e){switch(e){case 0:n.deviceMsgPart=!n.deviceMsgPart;break;case 1:n.userMsg=!n.userMsg;break;case 2:n.filterTab=!n.filterTab;break;case 3:n.waterTab=!n.waterTab;break;case 4:n.debugTab=!n.debugTab;break;case 5:n.debugHistroy=!n.debugHistroy;break;default:n.deviceMap=!n.deviceMap}}}]),app.controller("deviceTdsMapC",["$scope","$http","$location","$routeParams",function(r,e,i,t){layui.use(["form","layedit","laydate"],function(){layui.laydate.render({elem:"#date",type:"datetime",btns:["clear","confirm"],range:!0,done:function(e,t,i){e<1?(r.startTime="",r.endTime=""):(r.startTime=e.slice(0,20),r.endTime=e.slice(22))}})}),r.init=function(e,t,i,a,n){dataRequest("get",apiConfig.manage_device_tds_map,{startTime:e,endTime:t,provinceId:i,pageNum:a,pageSize:n},function(a){dataRequest("GET","common/getAreaInfo/list",{provinceId:i},function(e){for(var t=0;t<e.data.length;t++)for(var i=0;i<a.data.length;i++)e.data[t].id==a.data[i].provinceId&&(e.data[t].tds=a.data[i].tds,e.data[t].avg=a.data[i].avg);r.cityList=e.data,r.$apply()})})},r.init(r.startTime,r.endTime,r.provinceId,1,20),r.goDetail=function(e,t){sessionStorage.setItem("citys",JSON.stringify(t)),i.path("/deviceTdsDetail/"+e)},r.search=function(){r.init(r.startTime,r.endTime,r.provinceId,1,20)}}]),app.controller("deviceTdsDetailC",["$scope","$http","$location","$routeParams",function(d,e,t,i){layui.use(["form","layedit","laydate"],function(){layui.laydate.render({elem:"#date",type:"datetime",btns:["clear","confirm"],range:!0,done:function(e,t,i){e<1?(d.startTime="",d.endTime=""):(d.startTime=e.slice(0,20),d.endTime=e.slice(22))}})}),d.initCity=function(e,t,i,a,n,r){dataRequest("get",apiConfig.manage_device_tds_map,{startTime:e,endTime:t,provinceId:i,pageNum:a,pageSize:n},function(e){for(var t=0;t<r.length;t++)for(var i=0;i<e.data.length;i++)r[t].id==e.data[i].cityId&&(r[t].tds=e.data[i].tds,r[t].avg=e.data[i].avg);d.cityList=r,d.$apply()})},d.initCity(d.startTime,d.endTime,i.id,1,20,JSON.parse(sessionStorage.getItem("citys"))),d.search=function(){d.initCity(d.startTime,d.endTime,i.id,1,20,JSON.parse(sessionStorage.getItem("citys")))}}]);