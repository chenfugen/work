"use strict";app.controller("homeC",["$scope","$http","$location","$timeout",function(u,e,t,a){u.showPart=!0,JSON.parse(sessionStorage.getItem("permission")).forEach(function(e){"/web/api/manage/product/create"==e.url&&(u.isAdd=e.checked),"/web/api/manage/product/update"==e.url&&(u.isUpdate=e.checked),"/web/api/manage/product/detail"==e.url&&(u.isDetail=e.checked),"/web/api/manage/product/forbidden"==e.url&&(u.isSwitch=e.checked)});var l="",s="";u.goDetail=function(e){t.path("/proDetail/"+e)},$.get(config.webAPI.address+"manage/product/getCount",function(e){u.productCount=e.data,u.$apply()}),u.productTypeList=JSON.parse(sessionStorage.getItem("productType")),u.selProductList=JSON.parse(sessionStorage.getItem("productNameList")),u.netTypeList=JSON.parse(sessionStorage.getItem("netType")),u.init=function(e,t,a,r,i,o,s,n){dataRequest("GET","/manage/product/list",{productModel:e,leaseType:t,productName:a,producType:r,netType:i,pageNum:o,pageSize:s},function(e){u.productList=e.data,u.$apply(),n&&pageUtils(e.total,"productAll",function(e){u.init(u.productModel,l,u.productName,u.producType,u.netType,e.curr,e.limit,!1)})})},u.init("","","","","",1,10,!0),u.productSort=function(e){l=e,u.init(u.productModel,l,u.productName,u.producType,u.netType,1,10,!0)},u.search=function(){u.init(u.productModel,l,u.productName,u.producType,u.netType,1,10,!0)},u.close=function(){$(".layui-layer-shade").hide(),$(".layui-layer").hide()},u.form={resource:2,productName:"",erpNum:"",productModel:"",productType:"",netType:"",leaseType:""},u.addProduct=function(){u.productKey="",u.resource="",u.leaseType="",u.productModel="",$(".layui-layer-shade").show(),$(".add").show(),u.save=function(){return""==u.leaseType||null==u.leaseType?(alert("请选择租售类型！"),!1):""==u.resource||null==u.resource?(alert("请选择产品来源！"),!1):""==u.productModel||null==u.productModel?(alert("请输入产品型号！"),!1):""==u.productKey||null==u.productKey?(alert("请输入产品代码！"),!1):/^[\u3220-\uFA29]+$/.test(u.productKey)?(alert("请输入非中文代码！"),!1):(u.close(),void dataRequest("POST","manage/product/create",{productKey:u.productKey,resource:u.resource,leaseType:u.leaseType,productModel:u.productModel},function(e){e.success?(alert("获取成功!"),a(function(){t.path("/productEdit/"+u.productKey)},1)):alert(e.message)}))},u.add=function(){var e=new RegExp("[a-zA-Z0-9_一-龥]+$"),t=u.form.productName.length+u.form.productName.match(/[\u4E00-\u9FA5]/g);return 30<t||t<4?(alert("产品名称长度需为4～30位（中文算两位）"),!1):e.test(u.form.productName)?""==u.form.productName||null==u.form.productName?(alert("请输入产品名称！"),!1):""==u.form.erpNum||null==u.form.erpNum?(alert("请输入ERP编码！"),!1):""==u.form.productModel||null==u.form.productModel?(alert("请输入产品型号！"),!1):""==u.form.productType||null==u.form.productType?(alert("请输入产品类型！"),!1):""==u.form.leaseType?(alert("请选择通信类型！"),!1):""==u.form.netType?(alert("请选择租售类型！"),!1):void dataRequest("POST","manage/product/createIoTProduct",u.form,function(e){e.success?(alert("新增成功!"),u.init(u.productModel,l,u.productName,u.producType,u.netType,1,10,!0)):alert(e.message),u.close()}):(alert("产品名称需为中文、英文字母、数字、下划线"),!1)}},u.switch=function(t,e){1==t?$(".title").text("启用"):$(".title").text("禁用"),$(".layui-layer-shade").show(),$(".switch").show(),u.save=function(){u.close(),dataRequest("POST","manage/product/forbidden",{productKey:e,status:t},function(e){e.success?(1==t?alert("启用成功"):alert("禁用成功"),u.init(u.productModel,l,u.productName,u.producType,u.netType,1,10,!0)):alert(e.message)})}},u.edit=function(e){t.path("/productEdit/"+e)},u.refresh=function(e){dataRequest("post","manage/product/refresh",{productKey:e},function(e){e.success?(alert("刷新成功"),u.init(u.productModel,l,u.productName,u.producType,u.netType,1,10,!1)):alert(e.message)})},u.handleSubmitProductActAtt=function(){s=apiConfig.saveProductBatchOperate,u.productActAttForm.configs="";for(var e=[],t=0;t<u.productActAttList.length;t++)e.push(u.productActAttList[t].id);var a={configs:JSON.stringify(e),productKey:u.productActAttForm.productKey};console.log(a.configs),dataRequest("POST",s,a,function(e){alert(e.message),u.init(u.productModel,l,u.productName,u.producType,u.netType,1,10,!0),u.handleCancel()})},u.productActListAll=[],u.productActAttList=[],u.productActAttForm={productKey:"",configs:""},u.handleProductAddAtt=function(e){for(var t=!0,a=0;a<u.productActAttList.length;a++)u.productActAttList[a].id==e&&(u.productActAttForm.configs="",alert("该功能已添加"),t=!1);if(t)for(a=0;a<u.productActListAll.length;a++)e===u.productActListAll[a].id&&u.productActAttList.push(u.productActListAll[a])},u.handleProductSubAtt=function(e){u.productActAttList.splice(e,1)},u.getActAttByProduct=function(e){u.productActAttForm.productKey=e.productKey,s=apiConfig.getBatchOperateConfigByPK;var t={productKey:e.productKey};dataRequest("GET",s,t,function(e){u.productActListAll=e.data,u.$apply()}),s=apiConfig.getProductBatchOperateList,t={productKey:e.productKey},dataRequest("GET",s,t,function(e){u.productActAttList=e.data;for(var t=0;t<u.productActAttList.length;t++)u.productActAttList[t].id=u.productActAttList[t].configId;u.$apply(),$(".layui-layer-shade").show(),$(".checkAct").show()})},u.getActAttList=function(e,t,a,r,i,o){s=apiConfig.getBatchOperateConfigPage,dataRequest("GET",s,{productKey:e,operateName:t,status:a,pageNum:r,pageSize:i},function(e){u.actAttList=e.data,u.$apply(),o&&pageUtils(e.total,"actAttPage",function(e){u.getActAttList(u.actAttFilter.productKey,u.actAttFilter.operateName,u.actAttFilter.status,e.curr,e.limit,!1)})})},u.handleSearchAttList=function(){u.getActAttList(u.actAttFilter.productKey,u.actAttFilter.operateName,u.actAttFilter.status,1,10,!0)},u.actAttProductKeys=[],u.actAttForm={productKeys:"",operateName:"",batchName:"",url:""},u.handleEditActAtt=function(e){u.dialogTitle="编辑",s=apiConfig.getBatchOperateConfigInfo,dataRequest("GET",s,{id:e.id},function(e){for(var t=JSON.parse(e.data.productKeys),a=0;a<t.length;a++)for(var r=0;r<u.selProductList.length;r++)t[a]==u.selProductList[r].productKey&&u.actAttProductKeys.push(u.selProductList[r]);u.actAttForm={productKeys:"",operateName:e.data.operateName,batchName:e.data.batchName,url:e.data.url,id:e.data.id},u.$apply(),$(".layui-layer-shade").show(),$(".addAtt").show()})},u.handleForbiddenActAtt=function(e,t){e?(u.forbiddenActAtt={id:t.id,status:t.status},$(".layui-layer-shade").show(),$(".forbiddenActAtt").show()):(s=apiConfig.batch_operate_config_forbidden,dataRequest("POST",s,{id:u.forbiddenActAtt.id,status:1==u.forbiddenActAtt.status?0:1},function(e){e.success?alert("操作成功"):alert(e.message),u.getActAttList(u.actAttFilter.productKey,u.actAttFilter.operateName,u.actAttFilter.status,1,10,!0),u.handleCancel()}))},u.handleDeleteActAtt=function(e,t){if(e)u.deleteActAtt=t.id,$(".layui-layer-shade").show(),$(".deleteActAtt").show();else{s=apiConfig.batch_operate_config_delete;var a={id:u.deleteActAtt};dataRequest("POST",s,a,function(e){e.success?alert("操作成功"):alert(e.message),u.getActAttList(u.actAttFilter.productKey,u.actAttFilter.operateName,u.actAttFilter.status,1,10,!0),u.handleCancel()})}},u.handleViewProduct=function(e){for(var t=JSON.parse(e.productKeys),a=0;a<t.length;a++)for(var r=0;r<u.selProductList.length;r++)t[a]==u.selProductList[r].productKey&&u.actAttProductKeys.push(u.selProductList[r]);$(".layui-layer-shade").show(),$(".viewProduct").show()},u.actAttFilter={productKey:"",operateName:"",status:""},u.handleSubProducts=function(e){u.actAttProductKeys.splice(e,1)},u.handleAddAttProduct=function(e){u.dialogTitle="添加";for(var t=!0,a=0;a<u.actAttProductKeys.length;a++)if(u.actAttProductKeys[a].productKey==e){alert("该产品已添加"),u.actAttForm.productKeys="",t=!1;break}if(t)for(var r=0;r<u.selProductList.length;r++)u.selProductList[r].productKey==e&&u.actAttProductKeys.push(u.selProductList[r])},u.handleSubmit=function(){if(s=apiConfig.saveBatchOperateConfig,u.actAttProductKeys.length<1)return alert("请选择适配产品"),!1;if(""==u.actAttForm.operateName)return alert("请填写操作名称"),!1;if(""==u.actAttForm.url)return alert("请页面路径"),!1;for(var e=[],t=0;t<u.actAttProductKeys.length;t++)e.push(u.actAttProductKeys[t].productKey);var a={productKeys:JSON.stringify(e),operateName:u.actAttForm.operateName,url:u.actAttForm.url,batchName:u.actAttForm.batchName};u.actAttForm.id&&(a.id=u.actAttForm.id),dataRequest("POST",s,a,function(e){u.getActAttList(u.actAttFilter.productKey,u.actAttFilter.operateName,u.actAttFilter.status,1,10,!0),u.handleCancel()})},u.handleCancel=function(){u.productActAttList=[],u.productActAttForm={productKey:"",configs:""},u.actAttProductKeys=[],u.actAttForm={productKeys:"",operateName:"",batchName:"",url:""},$(".layui-layer-shade").hide(),$(".deleteActAtt").hide(),$(".addAtt").hide(),$(".forbiddenActAtt").hide(),$(".viewProduct").hide(),$(".checkAct").hide()},u.handleGoActStore=function(){u.showPart=!u.showPart,0==u.showPart?u.getActAttList("","","",1,10,!0):u.init("","","","","",1,10,!0)},u.handleAddAtt=function(){$(".layui-layer-shade").show(),$(".addAtt").show()}}]),app.controller("productAddC",["$scope","$http","$location","$routeParams",function(e,t,a,r){}]),app.controller("addAttributeC",["$scope","$http","$location","$routeParams",function(n,e,t,a){var r;JSON.parse(sessionStorage.getItem("permission")).forEach(function(e){"/web/api/manage/product/properties/save"==e.url&&(n.isSave=e.checked),"/web/api/manage/product/properties/delete"==e.url&&(n.isDelete=e.checked)}),n.init=function(e,t,a,r,i){dataRequest("GET","manage/product/properties/list",{pageNum:e,pageSize:t,name:a,dataType:r},function(e){for(var t in n.propertyList=[],e.data)n.propertyList[t]={},n.propertyList[t].attr=JSON.parse(e.data[t].properties),n.propertyList[t].id=e.data[t].id;n.$apply(),i&&pageUtils(e.total,"attributeList",function(e){n.init(e.curr,e.limit,n.attributeName,n.dataTypes,!1)})})},n.unitInit=function(){dataRequest("get","common/getUnitInfoList",{},function(e){n.units=e.data,n.$apply()})},n.init(1,10,n.attributeName,n.dataTypes,!0),n.unitInit(),n.search=function(){n.init(1,10,n.attributeName,n.dataTypes,!0)},n.addEnum=function(e){null==e?(isNaN(r)&&(r=n.attrNum.length-1),r++,n.attrNum.push({name:r,value:""})):(isNaN(r)&&(r=n.attributes[e].attrNum.length-1),r++,n.attributes[e].attrNum.push({name:r,value:""}))},n.removeEnum=function(e,t){r--,null==t?n.attrNum.splice(e,1):n.attributes[t].attrNum.splice(e,1)},n.dataType=function(e,t){if(1==e)switch($(".arrMsg").hide(),n.property.dataType.specs={},n.type){case"int":case"float":$(".int").show();break;case"enum":r=0,n.attrNum=[{name:0,value:""}],$(".enum").show();break;case"bool":n.value1=0,n.value2=1,$(".bool").show();break;case"text":$(".text").show();break;case"url":$(".url").show();break;case"struct":n.attributes=[{identifier:"",name:"",dataType:{specs:{},type:""}}],$(".struct").show();break;default:$(".struct").show()}else switch(n.attributes[t].dataType.specs={},delete n.attributes[t].units,$(".setMsg"+t).hide(),n.attributes[t].dataType.type){case"int":case"float":$(".intType"+t).show();break;case"enum":r=0,n.attributes[t].attrNum=[{name:0,value:""}],$(".enumType"+t).show();break;case"bool":n.value1=0,n.value2=1,$(".boolType"+t).show();break;case"text":$(".textType"+t).show();break;case"url":$(".urlType"+t).show();break;default:$(".intType"+t).show()}},n.addSet=function(){n.attributes.push({identifier:"",name:"",dataType:{specs:{},type:""}})},n.removeSet=function(e){n.attributes.splice(e,1)},n.jdugeAttr=function(){if(""==n.property.addressCode||null==n.property.addressCode)return alert("请填写长度为4的十六进制地址码！"),!1;if(!/^[0-9a-fA-F]+$/.test(n.property.addressCode)||4!=n.property.addressCode.length)return alert("请填写长度为4的十六进制地址码！"),!1;if(""==n.property.name)return alert("请填写属性名称！"),!1;if(""==n.property.identifier||null==n.property.identifier)return alert("请填写标识符！"),!1;if(!(e=/^\w+$/).test(n.property.identifier))return alert("请填写数字、英文或包括下划线组成标识符！"),!1;if(""==n.type)return alert("请选择数据类型！"),!1;if(n.property.dataType.type=n.type,"int"==n.type||"float"==n.type){var e="",t="";if(t="int"==n.type?(e=/^\d+$/,"整数的"):(e=/^(-?\d+)(\.\d+)?$/,"浮点的"),!e.test(n.min))return alert("请正确输入"+t+"最小值！"),!1;if(!e.test(n.max))return alert("请正确输入"+t+"最大值！"),!1;if(Number(n.min)>=Number(n.max))return alert(t+"最小值不能大于等于最大值"),!1;if(""==n.unit||null==n.unit)return alert("请选择单位！"),!1;n.property.dataType.specs.min=n.min,n.property.dataType.specs.max=n.max,n.property.dataType.specs.unit=n.unit.split("(")[1].split(")")[0],n.property.dataType.specs.unitName=n.unit.split("(")[0]}if("enum"==n.type){for(var a={},r=0;r<n.attrNum.length;r++){if(""==n.attrNum[r].value)return alert("请完整填写枚举型属性！"),!1;a[n.attrNum[r].name]=n.attrNum[r].value}n.property.dataType.specs=a}if("bool"==n.type){if((e=/^[0-9]+.?[0-9]*$/).test(n.bName1)||e.test(n.bName2))return alert("布尔值名称不能为数字!"),!1;if(""==n.bName1||""==n.bName2)return alert("请完整填写布尔值名称!"),!1;if(n.bName1==n.bName2)return alert("请布尔值名称1与名称2不能相同!"),!1;(a={})[n.value1]=n.bName1,a[n.value2]=n.bName2,n.property.dataType.specs=a}if("text"==n.type){if(!/^([1-9]\d*|[0]{1,1})$/.test(n.length))return alert("请输入正整数字符长度！"),!1;n.property.dataType.specs.length=n.length}if("url"==n.type){var i=/(http|https):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&:\/~\+#]*[\w\-\@?^=%&\/~\+#])?/;if(""==n.URL)return alert("请输入地址"),!1;if(!i.test(n.URL))return alert("请输入正确格式的地址！"),!1;n.property.dataType.specs.URL=n.URL}if("struct"==n.type){for(var o=0;o<n.attributes.length;o++){if(""==n.attributes[o].name)return alert("请填写复合型内置的属性名称！"),!1;if(""==n.attributes[o].identifier||null==n.attributes[o].identifier)return alert("请填写复合型内置的标识符！"),!1;if(!(e=/^\w+$/).test(n.attributes[o].identifier))return alert("请填写复合型内置的数字、英文或包括下划线组成的标识符！"),!1;if(""==n.attributes[o].dataType.type)return alert("请选择复合型内置的数据类型！"),!1;if(""==n.attributes[o].dataType.type)return alert("请选择复合型内置的数据类型！"),!1;if("int"==n.attributes[o].dataType.type||"float"==n.attributes[o].dataType.type){e="",t="";if(n.min=n.attributes[o].dataType.specs.min,n.max=n.attributes[o].dataType.specs.max,t="int"==n.attributes[o].dataType.type?(e=/^\d+$/,"复合型内置的整数的"):(e=/^(-?\d+)(\.\d+)?$/,"复合型内置的浮点的"),!e.test(n.min))return alert("请正确输入"+t+"最小值！"),!1;if(!e.test(n.max))return alert("请正确输入"+t+"最大值！"),!1;if(Number(n.min)>=Number(n.max))return alert(t+"最小值不能大于等于最大值"),!1;if(""==n.attributes[o].units||null==n.attributes[o].units)return alert("请选择复合型内置的单位！"),!1;n.attributes[o].dataType.specs.unit=n.attributes[o].units.split("(")[1].split(")")[0],n.attributes[o].dataType.specs.unitName=n.attributes[o].units.split("(")[0]}if("enum"==n.attributes[o].dataType.type){for(a={},r=0;r<n.attributes[o].attrNum.length;r++){if(""==n.attributes[o].attrNum[r].value)return alert("请完整填写复合型内置的枚举型属性！"),!1;a[n.attributes[o].attrNum[r].name]=n.attributes[o].attrNum[r].value}n.attributes[o].dataType.specs=a}if("bool"==n.attributes[o].dataType.type){e=/^[0-9]+.?[0-9]*$/;if(n.bName1=n.attributes[o].dataType.specs.bName1,n.bName2=n.attributes[o].dataType.specs.bName2,e.test(n.bName1)||e.test(n.bName2))return alert("布尔值名称不能为数字!"),!1;if(""==n.bName1||""==n.bName2)return alert("请完整填写布尔值名称!"),!1;if(n.bName1==n.bName2)return alert("请布尔值名称1与名称2不能相同!"),!1;(a={})[0]=n.bName1,a[1]=n.bName2,n.attributes[o].dataType.specs=a}if("url"==n.attributes[o].dataType.type){i=/(http|https):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&:\/~\+#]*[\w\-\@?^=%&\/~\+#])?/;if(n.URL=n.attributes[o].dataType.specs.URL,""==n.URL)return alert("请输入复合型内置的地址"),!1;if(!i.test(n.URL))return alert("请输入复合型内置的正确格式地址！"),!1}if("text"==n.attributes[o].dataType.type)if(!/^([1-9]\d*|[0]{1,1})$/.test(n.attributes[o].dataType.specs.length))return alert("请输入复合型内置的正整数字符长度！"),!1}n.attributes.forEach(function(e){e.attrNum&&delete e.attrNum,e.units&&delete e.units}),n.property.dataType.specs=n.attributes}return n.property.addressNum=n.property.addressCode,n.property.addressCode=parseInt(n.property.addressCode,16),!0},n.SaveAttribute=function(e,t,a,r,i){dataRequest("POST","manage/product/properties/save",{properties:e,id:t,name:r,dataType:i},function(e){e.success?(alert(a+"成功!"),n.init(1,10,n.attributeName,n.dataTypes,!0)):(alert(e.message),n.close())})},n.close=function(){$(".layui-layer-shade").hide(),$(".layui-layer").hide()},n.addAttr=function(){n.property={name:"",identifier:"",addressCode:"",dataType:{type:"",specs:""}},n.attributes=[{identifier:"",name:"",dataType:{specs:{},type:""}}],$(".arrMsg").hide(),$(".int").show(),n.type="",n.min="",n.max="",n.unit="",n.length="",n.URL="",n.bName1="",n.bName2="",$(".layui-layer-title").text("新增"),$(".layui-layer-shade").show(),$(".attribute").show(),$(".upDown").hide(),n.close=function(){$(".layui-layer-shade").hide(),$(".attribute").hide()},n.save=function(){n.jdugeAttr()&&(n.SaveAttribute(JSON.stringify(n.property),"","新增",n.property.name,n.property.dataType.type),n.close())}},n.delete=function(e){$(".layui-layer-shade").show(),$(".delete").show(),n.close=function(){$(".layui-layer-shade").hide(),$(".delete").hide()},n.remove=function(){dataRequest("POST","manage/product/properties/delete",{id:e},function(e){e.success?(alert("删除成功!"),n.close(),n.init(1,10,n.attributeName,n.dataTypes,!0)):(alert(e.message),n.close())})}},n.edit=function(e){switch(sessionStorage.setItem("attrs",JSON.stringify(e.attr.dataType.specs)),n.property=e.attr,n.property.addressCode=e.attr.addressNum,n.type=n.property.dataType.type,$(".arrMsg").hide(),$(".upDown").hide(),n.type){case"int":case"float":$(".int").show(),n.min=n.property.dataType.specs.min,n.max=n.property.dataType.specs.max,n.unit=n.property.dataType.specs.unitName+"("+n.property.dataType.specs.unit+")",$(".layui-select-title input").val(n.unit);break;case"enum":var t=[],a=[];for(var r in n.property.dataType.specs)t.push(r),a.push(n.property.dataType.specs[r]);var i=[];for(r=0;r<a.length;r++)i[r]={},i[r].name=t[r],i[r].value=a[r];n.attrNum=i,$(".enum").show();break;case"bool":$(".bool").show();var o=[];for(var s in n.property.dataType.specs)o.push(s);n.value1=o[0],n.value2=o[1],n.bName1=n.property.dataType.specs[0],n.bName2=n.property.dataType.specs[1];break;case"text":$(".text").show(),n.length=n.property.dataType.specs.length;break;case"url":$(".url").show(),n.URL=n.property.dataType.specs.URL;break;case"struct":n.attributes=n.property.dataType.specs,n.attributes.forEach(function(e,t){$(".setMsg"+t).hide()}),$(".upDown").show();break;default:$(".int").show()}$(".layui-layer-title").text("编辑"),$(".layui-layer-shade").show(),$(".attribute").show(),n.close=function(){$(".layui-layer-shade").hide(),$(".attribute").hide(),n.property.dataType.specs=JSON.parse(sessionStorage.getItem("attrs"))},n.upDown=function(){n.attributes.forEach(function(e,t){switch($(".setMsg"+t).hide(),e.dataType.type){case"int":case"float":e.units=e.dataType.specs.unitName+"("+e.dataType.specs.unit+")",$(".intType"+t).show();break;case"enum":var a=[],r=[];for(var i in e.dataType.specs)a.push(i),r.push(e.dataType.specs[i]);var o=[];for(i=0;i<r.length;i++)o[i]={},o[i].name=a[i],o[i].value=r[i];e.attrNum=o,$(".enumType"+t).show();break;case"bool":n.value1=0,n.value2=1,e.dataType.specs.bName1=e.dataType.specs[0],e.dataType.specs.bName2=e.dataType.specs[1],$(".boolType"+t).show();break;case"text":$(".textType"+t).show();break;case"url":$(".urlType"+t).show();break;default:$(".intType"+t).show()}}),$(".struct").show(),$(".upDown").hide()},n.save=function(){n.jdugeAttr()&&(n.SaveAttribute(JSON.stringify(n.property),e.id,"编辑",n.property.name,n.property.dataType.type),n.close())}},n.addUnit=!1,n.removeUnit=!1,n.showUnit=function(e){null==e?(n.unitName="",n.unitSymbol="",n.addUnit=!n.addUnit,n.removeUnit=!1):(n.attributes[e].removeUnit=!1,n.attributes[e].addUnit?n.attributes[e].addUnit=!1:n.attributes[e].addUnit=!0)},n.reduceUnit=function(e){null==e?(n.unitId="",n.addUnit=!1,n.removeUnit=!n.removeUnit):(n.attributes[e].addUnit=!1,n.attributes[e].removeUnit?n.attributes[e].removeUnit=!1:n.attributes[e].removeUnit=!0)},n.addUnits=function(t){if(null!=t&&(n.unitName=n.attributes[t].unitName,n.unitSymbol=n.attributes[t].unitSymbol),""==n.unitName||null==n.unitName)return alert("请输入中文单位名称!"),!1;return/[\u4e00-\u9fa5]/gm.test(n.unitName)?""==n.unitSymbol||null==n.unitSymbol?(alert("请输入对应的单位符号!"),!1):void dataRequest("POST","common/create/unitInfo",{name:n.unitName,symbol:n.unitSymbol},function(e){e.success?(alert("添加成功"),n.unitInit(),null!=t?(n.attributes[t].dataType.specs.unit=n.unitName+"("+n.unitSymbol+")",n.attributes[t].unitName,n.attributes[t].unitSymbol,n.attributes[t].addUnit=!1):(n.unit=n.unitName+"("+n.unitSymbol+")",n.unitName="",n.unitSymbol="",n.addUnit=!1)):alert(e.message)}):(alert("请输入正确的单位名称!"),!1)},n.removeUnits=function(t){if(null!=t&&(n.unitId=n.attributes[t].unitId),""==n.unitId||null==n.unitId)return alert("请输入要选择删除的单位!"),!1;dataRequest("POST","common/delete/unitInfo",{id:n.unitId},function(e){e.success?(alert("删除成功"),n.unitInit(),null!=t?(n.attributes[t].unitId,n.attributes[t].dataType.specs.unit=""):(n.unit="",n.unitId="")):alert(e.message)})}}]),app.controller("productEditC",["$scope","$http","$location","$routeParams",function(u,e,t,r){u.netFile={},u.wifiUseFile={},u.inputFile={},u.scanFile={},u.gprsUserFile={},u.bindFile={},u.flowCorrectionForm={productKey:null,waterType:null,standardFlow:null,minFlow:null,maxFlow:null,status:null},u.initFile=function(t){dataRequest("GET",apiConfig.manage_productFile_getProductFileInfo,{type:t,productKey:r.productKey},function(e){switch(null!=e.data&&null==e.data.fileName&&(e.data.fileName=e.data.fileId),null==e.data&&(e.data={fileId:null,type:t,fileName:"未配置"}),t){case 1:u.netFile=e.data;break;case 2:u.wifiUseFile=e.data;break;case 3:u.inputFile=e.data;break;case 4:u.scanFile=e.data;break;case 5:u.gprsUserFile=e.data;break;default:u.bindFile=e.data}u.$apply()})},u.productMsg=r,u.waters=[{name:"优",max:"",min:0},{name:"良",max:"",min:""},{name:"需要更换",max:"",min:""}],u.filterRelate={tds:300,ntu:.5,hclo:.5},u.deviceLeaseDebug={deviceLeaseMinutes:"24",deviceLeaseNum:""},u.initing=function(e,t,a,r,s,n){dataRequest("GET","manage/product/properties/list",{pageNum:e,pageSize:t,name:a,dataType:r},function(e){u.propertyList=[];var t=[];if(null!=n)for(var a=0;a<e.data.length;a++){t[a]={},t[a].attr=JSON.parse(e.data[a].properties);for(var r=t[a].attr.identifier,i=!1,o=0;o<n.length;o++)if(n[o].attr.identifier==r){i=!0;break}i||u.propertyList.push(t[a])}else for(var a in e.data)u.propertyList[a]={},u.propertyList[a].attr=JSON.parse(e.data[a].properties),u.propertyList[a].isUse=!1;u.properts=function(e,t,a){for(var r=[],i=e;i<t;i++)null!=a[i]&&r.push(a[i]);u.propertyNum=r,u.$apply()},u.properts(0,10,u.propertyList),s&&pageUtils(u.propertyList.length,"propertyAll",function(e){u.properts((e.curr-1)*e.limit,e.curr*e.limit,u.propertyList)})})},u.init=function(e){dataRequest("GET","manage/product/detail",{productKey:e},function(t){if(u.product=t.product,"NET_GPRS"!=u.product.netType?(u.initFile(1),u.initFile(2)):(u.initFile(3),u.initFile(4),u.initFile(5),u.initFile(6)),0<t.waterConfig.length?(u.flowCorrectionForm=t.waterConfig[0],u.flowCorrectionForm.status=1==t.waterConfig[0].status):u.flowCorrectionForm.status=!1,u.filters=t.filterProperties,""!=t.defineProperties){if(t.defineProperties.water&&(u.waters=t.defineProperties.water),0<t.defineProperties.filter.length&&t.defineProperties.filter)for(var e=0;e<u.filters.length;e++)for(var a=0;a<t.defineProperties.filter.length;a++)u.filters[e].identifier==t.defineProperties.filter[a].identifier&&(u.filters[e]=t.defineProperties.filter[a]);t.defineProperties.filterRelate&&(u.filterRelate=t.defineProperties.filterRelate),t.defineProperties.deviceLeaseDebug&&(u.deviceLeaseDebug=t.defineProperties.deviceLeaseDebug),t.defineProperties.propertyList&&(0<t.defineProperties.propertyList.length||""!=t.defineProperties.propertyList)&&(u.definePropertie=t.defineProperties.propertyList,u.defineProperties=function(e,t,a){for(var r=[],i=e;i<t;i++)null!=a[i]&&r.push(a[i]);u.arrList=r,u.$apply()},u.defineProperties(0,10,t.defineProperties.propertyList),pageUtils(t.defineProperties.propertyList.length,"arrList",function(e){u.defineProperties((e.curr-1)*e.limit,e.curr*e.limit,t.defineProperties.propertyList)}))}t.product.networkFile&&(u.networkFile=t.product.networkFile.split("getFile")[1].split("/")[1]),t.product.useFile&&(u.useFile=t.product.useFile.split("getFile")[1].split("/")[1]),u.propertieInit=function(e,t,a){for(var r=[],i=e;i<t;i++)null!=a[i]&&r.push(a[i]);u.properties=r,u.$apply()},u.propertieInit(0,10,t.properties),pageUtils(t.properties.length,"productAll",function(e){u.propertieInit((e.curr-1)*e.limit,e.curr*e.limit,t.properties)})})},u.init(r.productKey),u.updataFile=function(e,t){imgUpload("POST","manage/productFile/uploadProductFile?type="+t,e,function(e){if(e.success){switch(alert("上传成功！"),t){case 1:u.netFile.fileName=e.data.fileName,u.netFile.fileId=e.data.fileId;break;case 2:u.wifiUseFile.fileName=e.data.fileName,u.wifiUseFile.fileId=e.data.fileId;break;case 3:u.inputFile.fileName=e.data.fileName,u.inputFile.fileId=e.data.fileId;break;case 4:u.scanFile.fileName=e.data.fileName,u.scanFile.fileId=e.data.fileId;break;case 5:u.gprsUserFile.fileName=e.data.fileName,u.gprsUserFile.fileId=e.data.fileId;break;default:u.bindFile.fileName=e.data.fileName,u.bindFile.fileId=e.data.fileId}u.$apply(),u.close()}else alert(e.message)})},$("#netFile").uploadView({uploadBox:"#productAdd",allowType:["gif","jpeg","jpg","bmp","png"],maxSize:5,success:function(e){var t=new FormData,a=$("#netFile")[0].files[0],r=URL.createObjectURL(a);t.append("file",a),$(".imgUrl").attr("src",r),$(".imgName").text(a.name),$(".imgSize").text(a.size+"B"),$(".layui-layer-shade").show(),$(".addImage").show(),u.close=function(){$(".layui-layer-shade").hide(),$(".addImage").hide()},u.save=function(){u.updataFile(t,1)}}}),$("#wifiUseFile").uploadView({uploadBox:"#productAdd",allowType:["gif","jpeg","jpg","bmp","png"],maxSize:5,success:function(e){var t=new FormData,a=$("#wifiUseFile")[0].files[0],r=URL.createObjectURL(a);t.append("file",a),$(".imgUrl").attr("src",r),$(".imgName").text(a.name),$(".imgSize").text(a.size+"B"),$(".layui-layer-shade").show(),$(".addImage").show(),u.close=function(){$(".layui-layer-shade").hide(),$(".addImage").hide()},u.save=function(){u.updataFile(t,2)}}}),$("#inputFile").uploadView({uploadBox:"#productAdd",allowType:["gif","jpeg","jpg","bmp","png"],maxSize:5,success:function(e){var t=new FormData,a=$("#inputFile")[0].files[0],r=URL.createObjectURL(a);t.append("file",a),$(".imgUrl").attr("src",r),$(".imgName").text(a.name),$(".imgSize").text(a.size+"B"),$(".layui-layer-shade").show(),$(".addImage").show(),u.close=function(){$(".layui-layer-shade").hide(),$(".addImage").hide()},u.save=function(){u.updataFile(t,3)}}}),$("#scanFile").uploadView({uploadBox:"#productAdd",allowType:["gif","jpeg","jpg","bmp","png"],maxSize:5,success:function(e){var t=new FormData,a=$("#scanFile")[0].files[0],r=URL.createObjectURL(a);t.append("file",a),$(".imgUrl").attr("src",r),$(".imgName").text(a.name),$(".imgSize").text(a.size+"B"),$(".layui-layer-shade").show(),$(".addImage").show(),u.close=function(){$(".layui-layer-shade").hide(),$(".addImage").hide()},u.save=function(){u.updataFile(t,4)}}}),$("#gprsUserFile").uploadView({uploadBox:"#productAdd",allowType:["gif","jpeg","jpg","bmp","png"],maxSize:5,success:function(e){var t=new FormData,a=$("#gprsUserFile")[0].files[0],r=URL.createObjectURL(a);t.append("file",a),$(".imgUrl").attr("src",r),$(".imgName").text(a.name),$(".imgSize").text(a.size+"B"),$(".layui-layer-shade").show(),$(".addImage").show(),u.close=function(){$(".layui-layer-shade").hide(),$(".addImage").hide()},u.save=function(){u.updataFile(t,5)}}}),$("#bindFile").uploadView({uploadBox:"#bindFile",allowType:["gif","jpeg","jpg","bmp","png"],maxSize:5,success:function(e){var t=new FormData,a=$("#bindFile")[0].files[0],r=URL.createObjectURL(a);t.append("file",a),$(".imgUrl").attr("src",r),$(".imgName").text(a.name),$(".imgSize").text(a.size+"B"),$(".layui-layer-shade").show(),$(".addImage").show(),u.close=function(){$(".layui-layer-shade").hide(),$(".addImage").hide()},u.save=function(){u.updataFile(t,6)}}}),u.submitFlow=function(){if(u.flowCorrectionForm.minFlow>u.flowCorrectionForm.maxFlow)return alert("流量上限不能小于流量下限,请重新编辑"),!1;if(u.flowCorrectionForm.standardFlow>u.flowCorrectionForm.maxFlow||u.flowCorrectionForm.standardFlow<u.flowCorrectionForm.minFlow)return alert("流量标准不能小于流量下限或大于流量下限 ,请重新编辑"),!1;var e=apiConfig.manage_waterConfig_saveWaterCorrectConfig,t={productKey:r.productKey,waterType:0,standardFlow:u.flowCorrectionForm.standardFlow,minFlow:u.flowCorrectionForm.minFlow,maxFlow:u.flowCorrectionForm.maxFlow,status:u.flowCorrectionForm.status?1:0};u.flowCorrectionForm.id&&(t.id=u.flowCorrectionForm.id),dataRequest("POST",e,t,function(e){e.success?(alert(e.message),u.init(r.productKey)):alert(e.message)})},u.fillIn=function(e){if(!/^([1-9]\d*|[0]{1,1})$/.test(u.waters[e].max))return u.waters[e].max="",$(".err"+e).text("请输入正整数!"),!1;if(e<2){if(u.waters[e].min>=u.waters[e].max)return $(".err"+e).text(" 最小值必须小于最大值!"),u.waters[e].max="",u.waters[e+1].min="",event.stopPropagation(),!1;$(".err"+e).text(""),u.waters[e+1].min=u.waters[e].max-0+1,u.waters[e].max=parseInt(u.waters[e].max)}2==e&&(u.waters[e].min>=u.waters[e].max?($(".err"+e).text(" 最小值必须小于最大值!"),u.waters[e].max=""):($(".err"+e).text(""),u.waters[e].max=parseInt(u.waters[e].max)))},u.addProduct=function(e){if(2==e){for(var t=/^([1-9]\d*|[0]{1,1})$/,a=0;a<u.waters.length;a++)if(!t.test(u.waters[a].min)||!t.test(u.waters[a].max))return alert("请填写完整的正整数水质参数?"),!1;if("NET_WIFI"!=u.product.netType){if(""==u.deviceLeaseDebug.deviceLeaseMinutes||""==u.deviceLeaseDebug.deviceLeaseNum||null==u.deviceLeaseDebug.deviceLeaseNum)return alert("请选择完整的调试时间和次数!"),!1;if(!/^[1-9]+\d*$/.test(u.deviceLeaseDebug.deviceLeaseNum))return alert("调试次数请填写大于零的正整数!"),!1;if(u.filterRelate.tds<0||800<u.filterRelate.tds||null==u.filterRelate.tds)return alert("请填写完整的TDS值,且范围为整数0～800"),!1;if(u.filterRelate.ntu<0||2.55<u.filterRelate.ntu||null==u.filterRelate.ntu)return alert("请填写完整的浊度值,且范围为0～2.55"),!1;if(u.filterRelate.hclo<0||2.55<u.filterRelate.hclo||null==u.filterRelate.hclo)return alert("请填写完整的余氯值,且范围为0～2.55"),!1}for(a=0;a<u.filters.length;a++){if(""==u.filters[a].name||null==u.filters[a].name)return alert("滤芯"+(a+1)+"的名称不能为空！"),!1;if(""==u.filters[a].desc||null==u.filters[a].desc)return alert("滤芯"+(a+1)+"的描述不能为空！"),!1}}u.attributes={filter:u.filters,water:u.waters,propertyList:u.definePropertie,filterRelate:u.filterRelate,deviceLeaseDebug:u.deviceLeaseDebug},u.leaseType="售卖"==u.product.leaseType?"1":"2",dataRequest("POST","manage/product/update",{productKey:r.productKey,erpNum:"",leaseType:u.leaseType,definedMsg:JSON.stringify(u.attributes),productModel:""},function(e){e.success?(alert("编辑成功！"),u.init(r.productKey)):alert(e.message)})},u.fileSave=function(){var e={fileInfo:[],productKey:u.product.productKey};"NET_GPRS"==u.product.netType?(u.inputFile.fileId&&e.fileInfo.push({type:3,fileId:u.inputFile.fileId}),u.scanFile.fileId&&e.fileInfo.push({type:4,fileId:u.scanFile.fileId}),u.gprsUserFile.fileId&&e.fileInfo.push({type:5,fileId:u.gprsUserFile.fileId}),u.bindFile.fileId&&e.fileInfo.push({type:6,fileId:u.bindFile.fileId})):(u.netFile.fileId&&e.fileInfo.push({type:1,fileId:u.netFile.fileId}),u.wifiUseFile.fileId&&e.fileInfo.push({type:2,fileId:u.wifiUseFile.fileId})),e.fileInfo=JSON.stringify(e.fileInfo),dataRequest("POST",apiConfig.manage_productFile_saveProductFile,e,function(e){e.success?(alert("编辑成功！"),u.init(r.productKey)):alert(e.message),u.propertieInit(0,10,u.properties)})},u.addAttr=function(){u.initing(1,1e3,u.attributeName,u.dataTypes,!0,u.definePropertie),$(".layui-layer-shade").show(),$(".addAttr").show(),u.close=function(){$(".layui-layer-shade").hide(),$(".addAttr").hide()},u.save=function(){for(var e=0;e<u.propertyList.length;e++)1==u.propertyList[e].isUse&&(null==u.definePropertie&&(u.definePropertie=[]),u.definePropertie.push(u.propertyList[e]));u.addProduct(),u.close()}},u.delete=function(t){$(".layui-layer-shade").show(),$(".deleteAttr").show(),u.close=function(){$(".layui-layer-shade").hide(),$(".deleteAttr").hide()},u.save=function(){u.definePropertie=u.definePropertie.filter(function(e){return e.attr.identifier!=t}),2==u.product.resource&&(u.filters=u.filters.filter(function(e){return e.identifier!=t})),u.addProduct(),u.close()}},u.editProduct=function(){u.productModel=u.product.productModel,u.erpNum=u.product.erpNum,u.leaseType="售卖"==u.product.leaseType?"1":"2",$(".layui-layer-shade").show(),$(".editProduct").show(),u.close=function(){$(".layui-layer-shade").hide(),$(".editProduct").hide()},u.save=function(){return""==u.productModel||null==u.productModel?(alert("请填写产品型号?"),!1):""==u.erpNum||null==u.erpNum?(alert("请填写ERP编码?"),!1):""==u.leaseType||null==u.leaseType?(alert("租售类型不能为空?"),!1):(u.productModel==u.product.productModel&&(u.productModel=""),u.erpNum==u.product.erpNum&&(u.erpNum=""),u.close(),void dataRequest("POST","manage/product/update",{productKey:r.productKey,erpNum:u.erpNum,leaseType:u.leaseType,definedMsg:"",productModel:u.productModel},function(e){e.success?(alert("编辑成功！"),u.init(r.productKey)):alert(e.message)}))}},u.basicAttr=!0,u.selfAttr=!0,u.allocation=!0,u.flowCorrection=!0,u.waterTab=!0,u.filterTab=!0,u.packUpList=["收起"],u.packUp=function(e){u[e]=!u[e]}}]),app.controller("proDetailC",["$scope","$http","$location","$routeParams",function(o,e,t,a){o.netFile={},o.wifiUseFile={},o.inputFile={},o.scanFile={},o.gprsUserFile={},o.bindFile={},o.productNameList=JSON.parse(sessionStorage.getItem("productNameList")),o.init=function(e){dataRequest("GET","/manage/product/detail",{productKey:e},function(i){if(o.product=i.product,"NET_GPRS"!=o.product.netType?(o.initFile(1),o.initFile(2)):(o.initFile(3),o.initFile(4),o.initFile(5),o.initFile(6)),pageUtils(i.properties.length,"productAll",function(e){o.propertieInit((e.curr-1)*e.limit,e.curr*e.limit)}),o.filters=i.filterProperties,o.waterConfig=i.waterConfig[0],i.defineProperties){if(i.defineProperties.water&&(o.waters=i.defineProperties.water),i.defineProperties.filterRelate&&(o.filterRelate=i.defineProperties.filterRelate),i.defineProperties.deviceLeaseDebug&&(o.deviceLeaseDebug=i.defineProperties.deviceLeaseDebug),0<i.defineProperties.filter.length&&i.defineProperties.filter)for(var e=0;e<o.filters.length;e++)for(var t=0;t<i.defineProperties.filter.length;t++)o.filters[e].identifier==i.defineProperties.filter[t].identifier&&(o.filters[e]=i.defineProperties.filter[t]);o.propertyInit=function(e,t,a){for(var r=[],i=e;i<t;i++)null!=a[i]&&a[i].isUse&&r.push(a[i]);o.propertyList=r,o.$apply()},i.defineProperties.propertyList&&(o.propertyInit(0,10,i.defineProperties.propertyList),pageUtils(i.defineProperties.propertyList.length,"propertyAll",function(e){o.propertyInit((e.curr-1)*e.limit,e.curr*e.limit,i.defineProperties.propertyList)}))}o.networkFile=i.product.networkFile,o.useFile=i.product.useFile,o.propertieInit=function(e,t){for(var a=[],r=e;r<t;r++)null!=i.properties[r]&&a.push(i.properties[r]);o.properties=a,o.$apply()},o.propertieInit(0,10),o.$apply()}),dataRequest("get","manage/product/detail/getCount",{productKey:e},function(e){o.counts=e.data,o.$apply()})},o.init(a.id),o.selectPro=function(){o.init(o.productName)},o.edit=function(e){t.path("/productEdit/"+e)},o.initFile=function(t){dataRequest("GET",apiConfig.manage_productFile_getProductFileInfo,{type:t,productKey:o.product.productKey},function(e){switch(null!=e.data&&null==e.data.fileName&&(e.data.fileName=e.data.fileId),null==e.data&&(e.data={fileId:null,type:t,fileName:"未配置"}),t){case 1:o.netFile=e.data,o.netFile.href="/web/api/common/getFiles/"+e.data.fileId;break;case 2:o.wifiUseFile=e.data,o.wifiUseFile.href="/web/api/common/getFiles/"+e.data.fileId;break;case 3:o.inputFile=e.data,o.inputFile.href="/web/api/common/getFiles/"+e.data.fileId;break;case 4:o.scanFile=e.data,o.scanFile.href="/web/api/common/getFiles/"+e.data.fileId;break;case 5:o.gprsUserFile=e.data,o.gprsUserFile.href="/web/api/common/getFiles/"+e.data.fileId;break;default:o.bindFile=e.data,o.bindFile.href="/web/api/common/getFiles/"+e.data.fileId}o.$apply()})},o.basicAttr=!0,o.selfAttr=!0,o.allocation=!0,o.waterTab=!0,o.filterTab=!0,o.flowSet=!0,o.filterRelateTab=!0,o.deBugTab=!0,o.packUp=function(e){o[e]=!o[e]},o.watchImg=function(e){window.open().document.write("<img src="+e+" />")}}]);