"use strict";app.controller("softUpdateC",["$scope","$http","$location",function(o,e,a){o.productNameList=JSON.parse(sessionStorage.getItem("productNameList")),o.productTypeList=JSON.parse(sessionStorage.getItem("productType")),o.dialog=function(e,a){o.fun=e,o.id=a,o.dialogStyle="delete"==e||"on"==e||"off"==e?{zIndex:19891015,width:"400px",height:"170px",top:"30%",left:"50%",marginLeft:"-200px"}:{zIndex:19891015,width:"500px",height:"450px",top:"20%",left:"50%",marginLeft:"-200px"},"edit"==e&&dataRequest("get","manage/firmwareVersion/getFirmwareVersionInfo",{id:o.id},function(a){o.newForm=a.data,o.productNameList.forEach(function(e){e.productKey==a.data.productKey&&(o.newForm.productName=e.productName)}),o.$apply()}),"add"==e&&(o.newForm={productKey:"",productModel:"",firmwareModel:"",firmwareVersion:"",downLoadUrl:"",description:""}),$(".layui-layer-shade").show(),$(".layui-layer").show()},o.close=function(){$(".layui-layer-shade").hide(),$(".layui-layer").hide()},o.form={productType:"",moduleModel:"",productModel:"",firmwareVersion:""},o.init=function(e,a,t,r){dataRequest("get","manage/firmwareVersion/getFirmwareVersionList",_extends({pageNum:e,pageSize:a},t),function(e){o.firmwareList=e.data,r&&pageUtils(e.total,"firmwareList",function(e){o.init(e.curr,e.limit,o.form,!1)}),o.$apply()})},o.init(1,10,o.form,!0),o.updataFile=function(e){$.ajax({type:"POST",url:config.webAPI.address+"common/uploadImg",data:e,contentType:!1,cache:!1,processData:!1,xhr:function(){var e=$.ajaxSettings.xhr();return e.upload&&e.upload.addEventListener("progress",function(e){var a=e.loaded,t=e.total,r=Math.floor(100*a/t);$(".progress").css("width",r+"%")},!1),e},success:function(e){e.success?(alert("上传成功！"),o.newForm.downLoadUrl="http://"+window.location.host+"/web/api/common/getFiles/"+e.data.fileId):alert(e.message),$(".layui-progress").hide()},error:function(e){$(".layui-progress").hide()}})},layui.use("upload",function(){var i=layui.jquery;layui.upload.render({elem:"#testList",accept:"file",multiple:!0,auto:!1,choose:function(e){e.preview(function(e,a,t){if(83886080<a.size)return alert("上传文件超出80M大小!"),!1;i(".layui-progress").show(),i(".loading").hide();var r=new FormData;r.append("file",a),o.updataFile(r),o.newForm.downLoadUrl=a.name,o.$apply()})}})}),o.save=function(){if("add"==o.fun||"edit"==o.fun){if(""==o.newForm.productName)return alert("请选择产品类型！"),!1;if(""==o.newForm.firmwareModel)return alert("请选择模块型号！"),!1;if(""==o.newForm.firmwareVersion)return alert("请填写固件版本！"),!1;if(""==o.newForm.downLoadUrl)return alert("请上传新固件！"),!1;o.productNameList.forEach(function(e){e.productName==o.newForm.productName&&(o.newForm.productKey=e.productKey)}),dataRequest("post","manage/firmwareVersion/saveFirmwareVersion",o.newForm,function(e){e.success?("add"==o.fun?alert("新增成功！"):alert("编辑成功！"),o.init(1,10,o.form,!0)):alert(e.message)}),o.close()}else"delete"==o.fun?dataRequest("post","manage/firmwareVersion/deleteFirmwareVersion",{id:o.id},function(e){e.success?(alert("删除成功！"),o.init(1,10,o.form,!0)):alert(e.message)}):dataRequest("post","manage/firmwareVersion/forbidden",{id:o.id,status:"on"==o.fun?1:0},function(e){e.success?(alert("on"==o.fun?"启用":"禁用成功！"),o.init(1,10,o.form,!0)):alert(e.message)}),o.close()}}]),app.controller("appUpgradeC",["$scope","$http","$location",function(o,e,a){JSON.parse(sessionStorage.getItem("permission")).forEach(function(e){"/web/api/manage/upgrade/create/appVersion"==e.url&&(o.isAdd=e.checked),"/web/api/manage/upgrade/delete/appVersion"==e.url&&(o.isDelete=e.checked),"/web/api/manage/upgrade/list"==e.url&&(o.isList=e.checked)}),o.form={forceUpgrade:"",startTime:"",endTime:"",versionCode:""},o.addForm={type:"",versionCode:"",upgradeDate:"",jsonStr:""},layui.use(["form","layedit","laydate"],function(){layui.form,layui.layer,layui.layedit;layui.laydate.render({elem:"#datessss",btns:["clear","confirm"],type:"datetime",done:function(e,a,t){o.addForm.upgradeDate=e}}),layui.use("element",function(){layui.element})}),o.dialog=function(e,a){"showUser"==(o.fun=e)?(o.propertyInit=function(e,a,t){for(var r=[],i=e;i<a;i++)null!=t[i]&&r.push(t[i]);o.users=r},o.propertyInit(0,10,JSON.parse(a)),pageUtils(JSON.parse(a).length,"users",function(e){o.propertyInit((e.curr-1)*e.limit,e.curr*e.limit,JSON.parse(a))})):o.id=a,"delete"==e||"empty"==e?o.dialogStyle={zIndex:19891015,width:"400px",height:"170px",top:"30%",left:"50%",marginLeft:"-200px"}:"showUser"==e?o.dialogStyle={zIndex:19891015,width:"600px",maxHeight:"500px",height:"auto",top:"20%",left:"50%",marginLeft:"-300px"}:(o.addForm={type:"",versionCode:"",upgradeDate:"",jsonStr:""},o.phoneList="",o.dialogStyle={zIndex:19891015,width:"500px",maxHeight:"500px",height:"auto",top:"20%",left:"50%",marginLeft:"-200px"}),"add"==e&&(o.newForm={remark:"",explain:"",fileId:"",versionCode:""},o.upObject=""),$(".layui-layer-shade").show(),$(".layui-layer").show()},o.close=function(){$(".layui-layer-shade").hide(),$(".layui-layer").hide()},o.init=function(e,a,t,r){dataRequest("get","manage/upgrade/list",_extends({pageNum:e,pageSize:a},t),function(e){o.versionList=e.data,r&&pageUtils(e.total,"appVersion",function(e){o.init(e.curr,e.limit,o.form,!1)}),o.$apply()})},o.versionInit=function(a,e,t,r){dataRequest("get","manage/upgrade/appUpgrade/list",{pageNum:a,pageSize:e,type:t},function(e){o.nomal=e.data.nomal,o.forceUp=e.data.forceUpgrade,o.historyVer=e.data.history,"-"!=o.nomal.createTime&&1==a&&o.historyVer.unshift(o.nomal),"-"!=o.forceUp.createTime&&1==a&&o.historyVer.unshift(o.forceUp),o.type=t,o.historyInit=function(e,a,t){for(var r=[],i=e;i<a;i++)null!=t[i]&&r.push(t[i]);o.history=r,o.$apply()},o.historyInit(0,10,o.historyVer),pageUtils(o.historyVer.length,r,function(e){o.historyInit((e.curr-1)*e.limit,e.curr*e.limit,o.historyVer)})})},o.getVersionCode=function(){dataRequest("get","common/getVersionCode/list",{},function(e){o.versionCode=e.data,o.$apply()})},o.getVersionCode(),o.versionInit(1,10,1,"officialVersion"),o.init(1,10,o.form,!0),o.updataFile=function(e){$.ajax({type:"POST",url:config.webAPI.address+"manage/upgrade/upload/apk",data:e,contentType:!1,cache:!1,processData:!1,xhr:function(){var e=$.ajaxSettings.xhr();return e.upload&&e.upload.addEventListener("progress",function(e){var a=e.loaded,t=e.total,r=Math.floor(100*a/t);$(".progress").css("width",r+"%")},!1),e},success:function(e){e.success?(o.newForm.fileId=e.data.fileId,o.$apply()):alert(e.message),$(".layui-progress").hide()},error:function(e){$(".layui-progress").hide()}})},layui.use("upload",function(){var i=layui.jquery;layui.upload.render({elem:"#testList",accept:"file",multiple:!0,auto:!1,choose:function(e){e.preview(function(e,a,t){if(83886080<a.size)return alert("上传文件超出80M大小!"),!1;i(".layui-progress").show(),i(".loading").hide();var r=new FormData;r.append("apkFile",a),o.updataFile(r),o.$apply()})}})}),o.save=function(){if("add"==o.fun){if(""==o.newForm.versionCode)return alert("请填写app版本号！"),!1;if(""==o.newForm.fileId)return alert("请上传app安装包！"),!1;if(""==o.newForm.remark||null==o.newForm.remark)return alert("请填写版本备注！"),!1;if(""==o.newForm.explain||null==o.newForm.explain)return alert("请填写更新说明！"),!1;dataRequest("post","manage/upgrade/create/appVersion ",o.newForm,function(e){e.success?(alert("新增成功！"),o.init(1,10,o.form,!0),o.getVersionCode()):alert(e.message)})}if("versionAdd"==o.fun){if(""==o.addForm.forceUpgrade)return alert("请选择更新方式！"),!1;if(""==o.addForm.versionCode)return alert("请选择app版本号！"),!1;o.addForm.type=1,dataRequest("post","manage/upgrade/create/appUpgrade",o.addForm,function(e){e.success?(alert("新增成功！"),o.versionInit(1,10,1,"officialVersion")):alert(e.message)})}if("userAdd"==o.fun){if(""==o.addForm.forceUpgrade)return alert("请选择更新方式！"),!1;if(""==o.addForm.versionCode)return alert("请选择app版本号！"),!1;if(""==o.phoneList||null==o.phoneList)return alert("请填写要发送的用户号码！"),!1;var e=o.phoneList.split(",");o.numList=[];for(var a=0;a<e.length;a++){var t={phone:""};t.phone=e[a],o.numList.push(t)}o.addForm.type=2,o.addForm.jsonStr=JSON.stringify(o.numList),dataRequest("post","manage/upgrade/create/appUpgrade",o.addForm,function(e){e.success?(alert("新增成功！"),o.versionInit(1,10,2,"userVersion")):alert(e.message)})}"delete"==o.fun&&dataRequest("post","manage/upgrade/delete/appVersion",{id:o.id},function(e){e.success?(alert("删除成功！"),o.init(1,10,o.form,!0)):alert(e.message)}),"verDelete"==o.fun&&dataRequest("post","manage/upgrade/delete/appUpgrade",{id:o.id},function(e){e.success?(alert("删除成功！"),1==o.type?o.versionInit(1,10,1,"officialVersion"):o.versionInit(1,10,2,"userVersion")):alert(e.message)}),"empty"==o.fun&&dataRequest("post","manage/upgrade/reset/appUpgrade",{id:o.id},function(e){e.success?(alert("操作成功！"),1==o.type?o.versionInit(1,10,1,"officialVersion"):o.versionInit(1,10,2,"userVersion")):alert(e.message)}),o.close()}}]);